<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizAyiti - Aprann ak Plezi</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Application de quiz √©ducatif ha√Øtien - Apprendre en jouant avec QuizAyiti">
    <meta name="theme-color" content="#991b1b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="QuizAyiti">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <style>
        /* Variables pour th√®me clair/nuit */
        :root {
            --bg-gradient-start: #1e3a8a;
            --bg-gradient-end: #991b1b;
            --container-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --card-bg: #f8fafc;
            --border-color: #e2e8f0;
            --shadow: rgba(0,0,0,0.3);
            
            /* Surfaces blanches */
            --white-surface: #ffffff;
            --btn-secondary-bg: white;
            --option-bg: white;
            --modal-bg: white;
            --input-bg: white;
            --header-gradient-start: #1e40af;
            --header-gradient-end: #dc2626;
            
            /* Options correct/incorrect */
            --option-correct-bg: #d1fae5;
            --option-incorrect-bg: #fee2e2;
        }
        
        body.dark-mode {
            --bg-gradient-start: #0f172a;
            --bg-gradient-end: #7f1d1d;
            --container-bg: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --card-bg: #334155;
            --border-color: #475569;
            --shadow: rgba(0,0,0,0.6);
            
            /* Surfaces blanches en mode nuit */
            --white-surface: #334155;
            --btn-secondary-bg: #475569;
            --option-bg: #1e293b;
            --modal-bg: #1e293b;
            --input-bg: #334155;
            --header-gradient-start: #1e3a8a;
            --header-gradient-end: #991b1b;
            
            /* Options correct/incorrect en mode nuit (plus fonc√©s) */
            --option-correct-bg: #064e3b;
            --option-incorrect-bg: #7f1d1d;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            transition: background 0.3s ease;
        }

        .container {
            background: var(--container-bg);
            border-radius: 20px;
            box-shadow: 0 20px 60px var(--shadow);
            max-width: 500px;
            width: 100%;
            overflow: hidden;
            max-height: 95vh;
        }

        .header {
            background: linear-gradient(135deg, var(--header-gradient-start) 0%, var(--header-gradient-end) 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .settings-icon {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 20px;
            cursor: pointer;
            opacity: 0.9;
            transition: opacity 0.3s;
        }

        .pause-icon {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 20px;
            cursor: pointer;
            opacity: 0.9;
            background: rgba(255,255,255,0.2);
            padding: 8px 12px;
            border-radius: 8px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 3px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header .subtitle {
            font-size: 13px;
            opacity: 0.9;
            font-style: italic;
        }

        .content {
            padding: 20px;
            max-height: calc(95vh - 100px);
            overflow-y: auto;
        }

        /* √âcran de bienvenue */
        .welcome-screen {
            text-align: center;
            padding: 40px 20px;
        }

        .flag-animation {
            font-size: 80px;
            margin-bottom: 25px;
            animation: wave 2s ease-in-out infinite;
        }

        @keyframes wave {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }

        .welcome-title {
            font-size: 30px;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-weight: bold;
        }

        .welcome-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        /* √âcrans */
        .menu-screen, .category-screen, .quiz-screen, .result-screen, .leaderboard-screen, .settings-screen, .welcome-screen, .pause-screen, .profile-screen, .levels-screen, .daily-challenge-screen, .friends-screen, .level-up-screen {
            display: none;
        }

        .menu-screen.active, .category-screen.active, .quiz-screen.active, .result-screen.active, .leaderboard-screen.active, .settings-screen.active, .welcome-screen.active, .pause-screen.active, .profile-screen.active, .levels-screen.active, .daily-challenge-screen.active, .friends-screen.active, .level-up-screen.active {
            display: block;
        }

        .profile-section {
            text-align: center;
            margin-bottom: 20px;
        }

        .profile-avatar {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #3b82f6, #ef4444);
            border-radius: 50%;
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .profile-avatar:hover {
            transform: scale(1.1);
        }

        .profile-name {
            font-size: 22px;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .profile-level {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            cursor: pointer;
            transition: color 0.3s;
        }

        .profile-level:hover {
            color: #3b82f6;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: var(--card-bg);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .btn {
            width: 100%;
            padding: 14px;
            margin: 8px 0;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            position: relative;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
        }

        .btn-secondary {
            background: var(--white-surface);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: bold;
        }

        .category-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .category-card {
            background: var(--white-surface);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .category-card::before {
            content: attr(data-symbols);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 80px;
            opacity: 0.05;
            white-space: nowrap;
            pointer-events: none;
            z-index: 0;
            line-height: 1;
        }

        .category-card > * {
            position: relative;
            z-index: 1;
        }

        .category-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
            transform: translateY(-2px);
        }

        .category-card h3 {
            color: var(--text-primary);
            font-size: 16px;
            margin-bottom: 3px;
        }

        .category-card p {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .category-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .badge-francais { background: #dbeafe; color: #1e40af; }
        .badge-maths { background: #dcfce7; color: #166534; }
        .badge-sciences { background: #f3e8ff; color: #6b21a8; }
        .badge-creole { background: #fef3c7; color: #92400e; }
        .badge-culture-haitienne { background: #fee2e2; color: #991b1b; }
        .badge-culture-generale { background: #f1f5f9; color: #475569; }
        .badge-mixte { background: linear-gradient(135deg, #dbeafe, #fee2e2); color: var(--text-primary); }

        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .timer {
            background: #ef4444;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 16px;
        }

        .timer.warning {
            animation: pulse-warning 0.5s ease-in-out infinite;
        }

        @keyframes pulse-warning {
            0%, 100% { transform: scale(1); background: #ef4444; }
            50% { transform: scale(1.08); background: #dc2626; }
        }

        .progress {
            background: #e2e8f0;
            height: 6px;
            border-radius: 3px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, #3b82f6, #2563eb);
            height: 100%;
            transition: width 0.3s;
        }

        .question-card {
            background: var(--card-bg);
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .question-text {
            font-size: 16px;
            color: var(--text-primary);
            line-height: 1.5;
            font-weight: 500;
        }

        .options {
            display: grid;
            gap: 10px;
        }

        .option {
            background: var(--white-surface);
            border: 2px solid var(--border-color);
            padding: 14px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 15px;
            color: var(--text-primary);
        }

        .option:hover {
            border-color: #3b82f6;
            background: var(--card-bg);
        }

        .option.correct {
            border-color: #10b981;
            background: var(--option-correct-bg);
        }

        .option.incorrect {
            border-color: #ef4444;
            background: var(--option-incorrect-bg);
        }

        .explanation-card {
            background: var(--card-bg);
            border-left: 4px solid #3b82f6;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }

        .explanation-card.show {
            display: block;
        }

        .explanation-header {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            font-weight: 600;
            color: #3b82f6;
            font-size: 14px;
        }

        .explanation-icon {
            font-size: 16px;
            margin-right: 6px;
        }

        .explanation-text {
            color: var(--text-primary);
            font-size: 13px;
            line-height: 1.4;
        }

        /* Badge embl√®me */
        .badge-container {
            display: inline-block;
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border: 3px solid #cbd5e1;
            border-radius: 12px;
            padding: 15px;
            margin: 8px;
            text-align: center;
            min-width: 100px;
            position: relative;
            transition: all 0.3s;
        }

        .badge-container.unlocked {
            background: linear-gradient(135deg, #fef3c7, #fbbf24);
            border-color: #f59e0b;
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3);
        }

        .badge-container.locked {
            opacity: 0.7;
        }
        
        body.dark-mode .badge-container.locked {
            opacity: 0.9;
        }

        .badge-icon {
            font-size: 40px;
            margin-bottom: 8px;
        }

        .badge-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .badge-progress {
            font-size: 10px;
            color: var(--text-secondary);
        }

        .progress-mini {
            background: #e2e8f0;
            height: 4px;
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }

        .progress-mini-bar {
            background: #3b82f6;
            height: 100%;
        }

        /* Level up screen */
        .level-up-overlay {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.95), rgba(37, 99, 235, 0.95));
            padding: 40px 20px;
            text-align: center;
            animation: celebration 0.6s ease-out;
        }

        @keyframes celebration {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .level-up-icon {
            font-size: 100px;
            margin-bottom: 20px;
            animation: bounce 0.5s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .level-up-title {
            font-size: 32px;
            font-weight: bold;
            color: white;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .level-up-message {
            font-size: 18px;
            color: white;
            margin-bottom: 30px;
            opacity: 0.95;
        }

        .result-card {
            text-align: center;
            padding: 20px;
        }

        .result-icon {
            font-size: 70px;
            margin-bottom: 15px;
        }

        .result-score {
            font-size: 42px;
            font-weight: bold;
            color: #3b82f6;
            margin-bottom: 8px;
        }

        .result-text {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .stats {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .stat-value {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 15px;
        }

        .settings-section {
            margin-bottom: 20px;
        }

        .settings-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--card-bg);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .setting-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-primary);
        }

        .toggle-switch {
            position: relative;
            width: 46px;
            height: 24px;
            background: #cbd5e1;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #3b82f6;
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: var(--white-surface);
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(22px);
        }

        .input-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .input-field {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            margin: 0;
            width: auto;
        }

        .leaderboard-list {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 12px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--white-surface);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .leaderboard-item.you {
            background: var(--card-bg);
            border: 2px solid #3b82f6;
        }

        .rank {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
            font-size: 14px;
        }

        .rank.gold { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
        .rank.silver { background: linear-gradient(135deg, #94a3b8, #64748b); }
        .rank.bronze { background: linear-gradient(135deg, #f97316, #ea580c); }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        .player-stats {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .player-score {
            color: #3b82f6;
            font-weight: 600;
            font-size: 16px;
        }

        .your-rank-section {
            background: var(--card-bg);
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
            text-align: center;
        }

        .your-rank-title {
            font-size: 14px;
            font-weight: 600;
            color: #3b82f6;
            margin-bottom: 10px;
        }

        .your-rank-info {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .your-rank-message {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .back-btn {
            background: var(--card-bg);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .pause-modal {
            background: var(--white-surface);
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            max-width: 300px;
            margin: 0 auto;
        }

        .pause-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .profile-modal {
            background: var(--white-surface);
            border-radius: 16px;
            padding: 25px;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .level-progress-bar {
            background: #e2e8f0;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            margin: 15px 0;
        }

        .level-progress-fill {
            background: linear-gradient(90deg, #3b82f6, #2563eb);
            height: 100%;
            transition: width 0.3s;
        }

        .level-info {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .badges-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 20px 0 12px 0;
        }

        .levels-list {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 12px;
        }

        .level-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--white-surface);
            border-radius: 8px;
            margin-bottom: 8px;
            border: 2px solid transparent;
        }

        .level-item.current {
            border-color: #3b82f6;
            background: var(--card-bg);
        }

        .level-medal {
            font-size: 32px;
            margin-right: 15px;
        }

        .level-details {
            flex: 1;
        }

        .level-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 15px;
        }

        .level-range {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .daily-challenge-card {
            background: linear-gradient(135deg, #fef3c7, #fbbf24);
            border: 3px solid #f59e0b;
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 8px 20px rgba(251, 191, 36, 0.3);
        }

        .challenge-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .challenge-title {
            font-size: 22px;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .challenge-description {
            font-size: 14px;
            color: #475569;
            margin-bottom: 20px;
        }

        .challenge-reward {
            background: var(--white-surface);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .challenge-timer {
            font-size: 16px;
            font-weight: 600;
            color: #dc2626;
            margin-bottom: 20px;
        }

        @media (max-width: 480px) {
            .header h1 { font-size: 24px; }
            .question-text { font-size: 15px; }
            .option { padding: 12px; font-size: 14px; }
        }

        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #fbbf24;
            animation: confetti 3s linear;
        }

        /* C≈ìurs */
        .hearts-display {
            font-size: 24px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .hearts-display:hover {
            transform: scale(1.1);
        }

        .hearts-count {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .quiz-hearts {
            font-size: 20px;
        }

        /* Hearts Shop */
        .hearts-shop-screen {
            display: none;
        }

        .hearts-shop-screen.active {
            display: block;
        }

        .hearts-shop-card {
            background: linear-gradient(135deg, #fce7f3, #fbcfe8);
            border: 3px solid #ec4899;
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 8px 20px rgba(236, 72, 153, 0.3);
            margin-bottom: 20px;
        }

        .shop-hearts-display {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .shop-title {
            font-size: 22px;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .shop-description {
            font-size: 14px;
            color: #475569;
            margin-bottom: 20px;
        }

        .hearts-packs {
            display: grid;
            gap: 12px;
            margin-bottom: 20px;
        }

        .pack-card {
            background: var(--white-surface);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pack-card:hover {
            border-color: #ec4899;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(236, 72, 153, 0.2);
        }

        .pack-hearts {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .pack-price {
            font-size: 18px;
            font-weight: bold;
            color: #f59e0b;
        }

        /* No Hearts Modal */
        .no-hearts-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .no-hearts-card {
            background: var(--white-surface);
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            max-width: 350px;
            width: 100%;
        }

        .no-hearts-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .no-hearts-title {
            font-size: 24px;
            font-weight: bold;
            color: #ef4444;
            margin-bottom: 15px;
        }

        .no-hearts-message {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 25px;
        }

        /* Player Details Modal */
        .player-details-modal {
            display: none;
        }

        .player-details-modal.active {
            display: block;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .player-details-card {
            background: var(--white-surface);
            border-radius: 16px;
            padding: 25px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .player-details-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .player-details-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #3b82f6, #ef4444);
            border-radius: 50%;
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: white;
            font-weight: bold;
        }

        .category-symbols {
            font-size: 20px;
            margin-bottom: 10px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            display: inline-block;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Hearts Shop Modal */
        .hearts-shop-modal {
            display: none;
        }

        .hearts-shop-modal.active {
            display: block;
        }

        .hearts-shop-modal-card {
            background: var(--white-surface);
            border-radius: 16px;
            padding: 25px;
            max-width: 450px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Modal pour d√©tails pr√©cision */
        .precision-modal {
            display: none;
        }

        .precision-modal.active {
            display: block;
        }

        .precision-modal-card {
            background: var(--white-surface);
            border-radius: 16px;
            padding: 25px;
            max-width: 350px;
            width: 100%;
            text-align: center;
        }

        .precision-modal-title {
            font-size: 22px;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .precision-detail {
            font-size: 18px;
            color: #475569;
            margin-bottom: 15px;
        }

        /* Modal pour d√©tails points */
        .points-details-modal {
            display: none;
        }

        .points-details-modal.active {
            display: block;
        }

        .points-details-card {
            background: var(--white-surface);
            border-radius: 16px;
            padding: 25px;
            max-width: 400px;
            width: 100%;
        }

        .points-details-title {
            font-size: 22px;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 20px;
            text-align: center;
        }

        .points-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .points-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #3b82f6;
            margin-bottom: 10px;
        }

        .points-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .points-item:last-child {
            border-bottom: none;
        }

        .points-total {
            font-size: 20px;
            font-weight: bold;
            color: var(--text-primary);
            text-align: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #3b82f6;
        }

        /* Restore Modal */
        .restore-modal {
            display: none;
        }

        .restore-modal.active {
            display: block;
        }

        .restore-modal-card {
            background: var(--white-surface);
            border-radius: 16px;
            padding: 25px;
            max-width: 400px;
            width: 100%;
        }

        .restore-modal-title {
            font-size: 22px;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 15px;
            text-align: center;
        }

        /* Timer r√©g√©n√©ration c≈ìurs */
        .hearts-regen-timer {
            font-size: 13px;
            color: #10b981;
            margin-top: 10px;
            font-weight: 600;
        }

        /* ========== SYST√àME AMIS ========== */
        .friends-sections {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .friends-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 15px;
        }

        .friends-section-header h3 {
            color: var(--text-primary);
            font-size: 16px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .friends-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .friend-request-item,
        .friend-item {
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .friend-name {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 15px;
        }

        .friend-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s, opacity 0.2s;
        }

        .btn-small:active {
            transform: scale(0.95);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            opacity: 0.9;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            opacity: 0.9;
        }

        .no-friends {
            text-align: center;
            color: var(--text-secondary);
            padding: 30px;
            font-style: italic;
        }

        .search-result {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .search-result-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .search-result-points {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="settings-icon" id="settingsIcon" onclick="showSettings()" style="display: none;">‚öôÔ∏è</div>
            <h1>üá≠üáπ QuizAyiti</h1>
            <p class="subtitle">Aprann ak Plezi</p>
        </div>

        <div class="content">
            <!-- √âcran de Bienvenue -->
            <div class="welcome-screen active">
                <div class="flag-animation">üá≠üáπ</div>
                <div class="welcome-title">Byenveni nan QuizAyiti!</div>
                <div class="welcome-subtitle">Apprendre en jouant</div>
                <button class="btn btn-primary" onclick="closeWelcome()">K√≤manse üöÄ</button>
            </div>

            <!-- Menu Principal -->
            <div class="menu-screen">
                <div class="profile-section">
                    <div class="profile-avatar" id="profileAvatar" onclick="showProfile()">E</div>
                    <div class="profile-name" id="profileName">√ârudit</div>
                    <div class="profile-level" id="profileLevel" onclick="showLevels()">ü•â D√©butant</div>
                    <div id="syncBadge" style="display: none; background: #fbbf24; color: #1e293b; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; margin: 8px auto 0; text-align: center; width: fit-content;">
                        üì° Sync en attente...
                    </div>
                    <div class="hearts-display" id="heartsDisplay" onclick="showHeartsShopModal()" style="cursor: pointer;">
                        <span>‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
                        <span style="margin-left: 8px; font-size: 22px;" title="Boutique">üõí</span>
                        <div class="hearts-count" id="heartsCount">(3 vies)</div>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="userPoints">0</div>
                        <div class="stat-label">Points</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="userCoins">0</div>
                        <div class="stat-label">ü™ô Jetons</div>
                    </div>
                    <div class="stat-box" onclick="showPrecisionDetails()" style="cursor: pointer;" title="Voir les d√©tails">
                        <div class="stat-value" id="userAccuracy">0%</div>
                        <div class="stat-label">üìä Pr√©cision</div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="showCategories()">üéØ Jouer Maintenant</button>
                <button class="btn btn-secondary" onclick="showLeaderboard()">üèÜ Classement</button>
                <button class="btn btn-secondary" id="dailyChallengeBtn" onclick="showDailyChallenge()">
                    ‚ö° D√©fi Quotidien
                    <span class="notification-badge" id="challengeBadge" style="display: none;">NOUVEAU</span>
                </button>
                <button class="btn btn-secondary" onclick="showFriendsScreen()">
                    üë• Amis
                    <span class="notification-badge" id="friendsBadge" style="display: none;">NOUVEAU</span>
                </button>
            </div>

            <!-- √âcran Profil -->
            <div class="profile-screen">
                <div class="profile-modal">
                    <button class="back-btn" onclick="showMenu()">‚Üê Retour</button>
                    <div class="profile-header">
                        <div class="profile-avatar" style="width: 80px; height: 80px; font-size: 40px; margin: 0 auto 10px;" id="profileAvatarModal">E</div>
                        <div class="profile-name" id="profileNameModal">√ârudit</div>
                        <div class="profile-level" id="profileLevelModal">ü•â D√©butant</div>
                        <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">
                            <strong id="totalBadgesCount">0</strong> badges gagn√©s üèÖ
                        </div>
                    </div>
                    
                    <div class="section-title">Progression</div>
                    <div class="level-progress-bar">
                        <div class="level-progress-fill" id="levelProgressFill" style="width: 0%"></div>
                    </div>
                    <div class="level-info">
                        <span id="currentLevelPoints">0 pts</span>
                        <span id="nextLevelPoints">500 pts</span>
                    </div>
                    <div style="text-align: center; font-size: 14px; color: var(--text-secondary); margin-bottom: 20px;">
                        <strong>Prochain niveau :</strong> <span id="nextLevelName">ü•à Apprenti</span><br>
                        <span id="pointsToNext">Encore 500 points !</span>
                    </div>

                    <div class="section-title">üìä Statistiques</div>
                    <div class="stats">
                        <div class="stat-row">
                            <span class="stat-label">Parties jou√©es</span>
                            <span class="stat-value" id="totalGamesProfile">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Bonnes r√©ponses</span>
                            <span class="stat-value" id="correctAnswersProfile">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Mauvaises r√©ponses</span>
                            <span class="stat-value" id="wrongAnswersProfile">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Pr√©cision</span>
                            <span class="stat-value" id="accuracyProfile">0%</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">S√©rie actuelle</span>
                            <span class="stat-value" id="streakProfile">0 jours üî•</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Jetons collect√©s</span>
                            <span class="stat-value" id="coinsProfile">0 ü™ô</span>
                        </div>
                    </div>

                    <div class="section-title">üîë Code de Sauvegarde</div>
                    <div style="background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 10px;">
                            Sauvegarde ce code pour r√©cup√©rer ton compte sur un autre appareil
                        </div>
                        <input type="text" id="recoveryCodeDisplay" readonly style="width: 100%; padding: 12px; background: var(--input-bg); border: 2px solid var(--border-color); border-radius: 8px; font-weight: bold; font-size: 16px; text-align: center; letter-spacing: 1px; margin-bottom: 10px; color: var(--text-primary);" value="QUIZ-XXXX-XXXX-XXXX">
                        <button class="btn btn-primary" onclick="copyRecoveryCode()" style="width: 100%;">üìã Copier le Code</button>
                    </div>

                    <div class="section-title">üèÖ Embl√®mes</div>
                    <div class="badges-grid" id="badgesGrid"></div>
                </div>
            </div>

            <!-- √âcran Niveaux -->
            <div class="levels-screen">
                <button class="back-btn" onclick="showMenu()">‚Üê Retour</button>
                <h2 style="margin-bottom: 15px; color: var(--text-primary); font-size: 18px;">üèÜ Tous les Niveaux</h2>
                <div class="levels-list" id="levelsList"></div>
            </div>

            <!-- D√©fi Quotidien -->
            <div class="daily-challenge-screen">
                <button class="back-btn" onclick="showMenu()">‚Üê Retour</button>
                <div class="daily-challenge-card" id="dailyChallengeCard"></div>
            </div>

            <!-- √âcran Amis -->
            <div class="friends-screen">
                <button class="back-btn" onclick="showMenu()">‚Üê Retour</button>
                <h2 style="margin-bottom: 20px; color: var(--text-primary); font-size: 20px; text-align: center;">üë• Mes Amis</h2>
                
                <button class="btn btn-primary" onclick="showSearchFriendModal()" style="margin-bottom: 20px;">
                    üîç Rechercher un ami
                </button>
                
                <div class="friends-sections">
                    <!-- Demandes re√ßues -->
                    <div class="friends-section">
                        <div class="friends-section-header">
                            <h3>üì¨ Demandes re√ßues (<span id="friendRequestsCount">0</span>)</h3>
                        </div>
                        <div id="friendRequestsList" class="friends-list"></div>
                    </div>
                    
                    <!-- Mes amis -->
                    <div class="friends-section">
                        <div class="friends-section-header">
                            <h3>‚úÖ Mes amis (<span id="friendsCount">0</span>)</h3>
                        </div>
                        <div id="friendsList" class="friends-list"></div>
                    </div>
                </div>
            </div>

            <!-- S√©lection Th√©matique -->
            <div class="category-screen">
                <button class="back-btn" onclick="showMenu()">‚Üê Retour</button>
                <h2 style="margin-bottom: 15px; color: var(--text-primary); font-size: 18px;">Choisis ta th√©matique</h2>
                <div class="category-grid" id="categoryGrid"></div>
            </div>

            <!-- √âcran Quiz -->
            <div class="quiz-screen">
                <div class="pause-icon" onclick="pauseQuiz()">‚è∏</div>
                <div id="categoryBadge" class="category-badge"></div>
                <div class="quiz-header">
                    <div style="font-size: 14px; color: var(--text-secondary);">Question <span id="currentQ">1</span>/<span id="totalQ">10</span></div>
                    <div class="quiz-hearts" id="quizHearts" onclick="openShopFromQuiz()" style="cursor: pointer;" title="Acheter des vies">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                    <div class="timer" id="timer">30</div>
                </div>
                <div class="progress">
                    <div class="progress-bar" id="progressBar" style="width: 10%"></div>
                </div>
                <div class="question-card">
                    <div class="question-text" id="questionText">Chargement...</div>
                </div>
                <div class="options" id="options"></div>
                <div class="explanation-card" id="explanationCard">
                    <div class="explanation-header">
                        <span class="explanation-icon">üí°</span>
                        <span>Explication</span>
                    </div>
                    <div class="explanation-text" id="explanationText"></div>
                </div>
                <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()" style="display: none; margin-top: 15px;">Suivant ‚Üí</button>
            </div>

            <!-- Pause Modal -->
            <div class="pause-screen">
                <div class="pause-modal">
                    <div class="pause-title">‚è∏ Pause</div>
                    <button class="btn btn-primary" onclick="resumeQuiz()">‚ñ∂Ô∏è Continuer</button>
                    <button class="btn btn-secondary" onclick="showSettingsFromPause()">‚öôÔ∏è Param√®tres</button>
                    <button class="btn btn-secondary" onclick="restartQuiz()">üîÑ Recommencer</button>
                    <button class="btn btn-secondary" onclick="changeThemeFromPause()">üéØ Changer th√©matique</button>
                    <button class="btn btn-secondary" onclick="quitQuiz()">üè† Quitter</button>
                </div>
            </div>

            <!-- Level Up Screen -->
            <div class="level-up-screen">
                <div class="level-up-overlay">
                    <div class="level-up-icon" id="levelUpIcon">üéâ</div>
                    <div class="level-up-title" id="levelUpTitle">F√©licitations !</div>
                    <div class="level-up-message" id="levelUpMessage">Tu es maintenant Apprenti !</div>
                    <button class="btn btn-primary" onclick="closeLevelUp()" style="background: var(--white-surface); color: #1e40af;">Continuer üöÄ</button>
                </div>
            </div>

            <!-- √âcran R√©sultats -->
            <div class="result-screen">
                <div class="result-card">
                    <div class="result-icon" id="resultIcon">üéâ</div>
                    <div class="result-score"><span id="finalPoints">0</span> pts</div>
                    <div class="result-text" id="resultText">Excellent travail !</div>
                    <div class="stats">
                        <div class="stat-row">
                            <span class="stat-label">Bonnes r√©ponses</span>
                            <span class="stat-value" id="correctAnswers">0/10</span>
                        </div>
                        <div class="stat-row" onclick="showPointsDetails()" style="cursor: pointer;" title="Voir les d√©tails">
                            <span class="stat-label">Points gagn√©s</span>
                            <span class="stat-value" id="pointsGained">+0</span>
                        </div>
                        <div class="stat-row" onclick="showPointsDetails()" style="cursor: pointer;" title="Voir les d√©tails">
                            <span class="stat-label">Points bonus</span>
                            <span class="stat-value" id="bonusPoints">+0</span>
                        </div>
                        <div class="stat-row" onclick="showCoinsDetails()" style="cursor: pointer;" title="Voir les d√©tails">
                            <span class="stat-label">Jetons gagn√©s</span>
                            <span class="stat-value" id="coinsGained">+0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Niveau actuel</span>
                            <span class="stat-value" id="newLevel">ü•â D√©butant</span>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="restartQuiz()">üîÑ Rejouer</button>
                    <button class="btn btn-secondary" onclick="showCategories()">üìö Changer th√©matique</button>
                    <button class="btn btn-secondary" onclick="showLeaderboard()">üèÜ Voir le Classement</button>
                    <button class="btn btn-secondary" onclick="showMenu()">üè† Menu Principal</button>
                </div>
            </div>

            <!-- Classement -->
            <div class="leaderboard-screen">
                <button class="back-btn" onclick="goBackFromLeaderboard()">‚Üê Retour</button>
                <h2 style="margin-bottom: 15px; color: var(--text-primary); font-size: 18px;">üèÜ Classement Global</h2>
                <div style="text-align: center; margin-bottom: 10px; font-size: 13px; color: var(--text-secondary);">Top 10</div>
                <div class="leaderboard-list" id="leaderboardList"></div>
                <div class="your-rank-section" id="yourRankSection" style="display: none;">
                    <div class="your-rank-title">TON RANG</div>
                    <div class="your-rank-info" id="yourRankInfo">#15 - Kenley</div>
                    <div class="player-stats" id="yourRankStats">890 pts ‚Ä¢ 450 ü™ô</div>
                    <div class="your-rank-message" id="yourRankMessage">‚Üë Continue ! Plus que 340 pts pour le Top 10 !</div>
                </div>
            </div>

            <!-- Param√®tres -->
            <div class="settings-screen">
                <button class="back-btn" onclick="closeSettings()">‚Üê Retour</button>
                <h2 style="margin-bottom: 15px; color: var(--text-primary); font-size: 18px;">‚öôÔ∏è Param√®tres</h2>
                
                <div class="settings-section">
                    <div class="settings-title">Apparence</div>
                    <div class="setting-item">
                        <div class="setting-label">
                            <span>üåô</span>
                            <span>Mode Nuit</span>
                        </div>
                        <div class="toggle-switch" id="darkModeToggle" onclick="toggleDarkMode()">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-title">Audio et Vibrations</div>
                    <div class="setting-item">
                        <div class="setting-label">
                            <span>üîî</span>
                            <span>Sons</span>
                        </div>
                        <div class="toggle-switch" id="soundToggle" onclick="toggleSound()">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div class="setting-label">
                            <span>üì≥</span>
                            <span>Vibrations</span>
                        </div>
                        <div class="toggle-switch active" id="vibrationToggle" onclick="toggleVibration()">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-title">Pr√©f√©rences de Jeu</div>
                    <div class="setting-item">
                        <div class="setting-label">
                            <span>‚è±Ô∏è</span>
                            <span>Dur√©e par question</span>
                        </div>
                        <select id="timerDuration" onchange="saveTimerDuration()" style="padding: 6px; border-radius: 6px; border: 2px solid var(--border-color); font-size: 13px; background: var(--input-bg); color: var(--text-primary);">
                            <option value="30">30s</option>
                            <option value="45">45s</option>
                        </select>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-title">Profil</div>
                    <div class="setting-item">
                        <div class="input-group">
                            <input type="text" id="nameInput" class="input-field" placeholder="Votre nom">
                            <button class="btn btn-primary btn-small" onclick="changeName()">‚úì</button>
                        </div>
                    </div>
                </div>

                <button class="btn btn-secondary" onclick="showRestoreModal()">üîë Restaurer mon compte</button>
                <button class="btn btn-secondary" onclick="resetData()">üóëÔ∏è R√©initialiser</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, remove, update, onValue, query, orderByChild, limitToLast } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyA-3CZvY0p8A0-k7ZHCRR5VPqZTeTKm4Lw",
            authDomain: "quizayiti-e655a.firebaseapp.com",
            databaseURL: "https://quizayiti-e655a-default-rtdb.firebaseio.com",
            projectId: "quizayiti-e655a",
            storageBucket: "quizayiti-e655a.firebasestorage.app",
            messagingSenderId: "182539004143",
            appId: "1:182539004143:web:3dd584df1514e9d0e3931a"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebaseRemove = remove; // ‚úÖ AJOUT√â : n√©cessaire pour syst√®me amis
        window.firebaseUpdate = update;
        window.firebaseOnValue = onValue;
        window.firebaseQuery = query;
        window.firebaseOrderByChild = orderByChild;
        window.firebaseLimitToLast = limitToLast;
        
        console.log('‚úÖ Firebase initialis√©');
        initApp();
        
        // Enregistrement du Service Worker pour PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker enregistr√©:', registration.scope);
                    })
                    .catch(error => {
                        console.log('‚ùå Erreur Service Worker:', error);
                    });
            });
        }
        
        // Gestion du prompt d'installation PWA
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('üíæ Installation PWA disponible');
            // L'utilisateur peut maintenant installer l'app via son navigateur
        });
        
        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ PWA install√©e avec succ√®s !');
            deferredPrompt = null;
        });
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script>
        // Configuration
        const GOOGLE_SHEETS_API_KEY = 'AIzaSyA125rJg-7CExfMd9LePRGAQwS4bHMWoDQ';
        const SPREADSHEET_ID = '1exBmy58PSeStY04L9-j3YHgrfnbVSYwB9Aw0cQ95FKI';
        const SHEET_NAME = 'Questions';

        // Variables globales
        let userId = '';
        let userData = {
            name: '',
            points: 0,
            coins: 0,
            hearts: 3,
            purchasedHearts: 0,
            lastHeartReset: '',
            lastHeartRegenTime: '', // NOUVEAU pour r√©g√©n√©ration 1h
            totalGames: 0,
            correctAnswers: 0,
            totalAnswers: 0,
            streak: 0,
            lastPlayed: '',
            level: 1,
            perfectGames: 0,
            badges: {},
            badgeProgress: {},
            categoryStats: {},
            dailyChallengeCompleted: false,
            lastChallengeDate: '',
            recoveryCode: '',
            // ‚úÖ SYST√àME AMIS
            friends: {}, // { friendId: { name, addedDate } }
            friendRequests: {}, // { senderId: { name, date } }
            sentRequests: {} // { receiverId: { name, date } }
        };

        let allQuestions = [];
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let correctCount = 0;
        let timerInterval;
        let heartRegenInterval; // NOUVEAU pour timer r√©g√©n√©ration
        let timeLeft = 30;
        let currentCategory = '';
        let currentCategoryKey = ''; // Vraie cat√©gorie Google Sheets
        let currentCategoryBadge = '';
        let sessionPoints = 0;
        let sessionCoins = 0;
        let sessionBonusPoints = 0;
        let sessionChallengeReward = 0; // NOUVEAU pour afficher r√©compense d√©fi s√©par√©ment
        let quizPaused = false;
        let pausedTime = 0;
        let fromSettings = false;
        let fromShop = false;
        let returnToScreen = 'menu';
        let previousLevel = 1;
        let pointsBeforeQuiz = 0; // Points avant de commencer le quiz
        let deferredPrompt = null; // Pour l'installation PWA

        // Audio
        let pianoSynth;
        let violinSynth;
        let soundEnabled = false;
        let vibrationEnabled = true;
        let timerDuration = 30;

        // Mode nuit
        let darkModeEnabled = false;

        // Sync offline
        let needsSync = false;
        let isOnline = navigator.onLine;

        // Niveaux NOUVEAUX
        const LEVELS = [
            { min: 0, max: 1000, name: 'D√©butant', medal: 'ü•â' },
            { min: 1001, max: 2500, name: 'Apprenti', medal: 'ü•à' },
            { min: 2501, max: 4000, name: '√âtudiant', medal: 'ü•á' },
            { min: 4001, max: 7000, name: 'Savant', medal: 'üíé' },
            { min: 7001, max: 10000, name: 'Expert', medal: 'üß†' },
            { min: 10001, max: 15000, name: 'Expert ‚≠ê', medal: 'üß†‚≠ê' },
            { min: 15001, max: 20000, name: 'Expert ‚≠ê‚≠ê', medal: 'üß†‚≠ê‚≠ê' },
            { min: 20001, max: 25000, name: 'Ma√Ætre ‚≠ê', medal: 'üëë‚≠ê' },
            { min: 25001, max: 32000, name: 'Ma√Ætre ‚≠ê‚≠ê', medal: 'üëë‚≠ê‚≠ê' },
            { min: 32001, max: 40000, name: 'Ma√Ætre ‚≠ê‚≠ê‚≠ê', medal: 'üëë‚≠ê‚≠ê‚≠ê' },
            { min: 40001, max: 50000, name: 'Ma√Ætre ‚≠ê‚≠ê‚≠ê‚≠ê', medal: 'üëë‚≠ê‚≠ê‚≠ê‚≠ê' },
            { min: 50001, max: 999999, name: 'L√©gende', medal: 'üèÜ' }
        ];

        // Embl√®mes NOUVEAUX - Syst√®me progressif CORRIG√â
        const BADGES = [
            { 
                id: 'first_quiz', 
                name: 'Premier Pas', 
                icon: 'üéØ', 
                levels: [1, 5, 10, 25, 50, 100, 150],
                getProgress: (data) => data.totalGames || 0,
                getNextTarget: (current) => {
                    const targets = [1, 5, 10, 25, 50, 100, 150];
                    return targets.find(t => t > current) || 150;
                },
                descriptions: ['1 quiz jou√©', '5 quiz jou√©s', '10 quiz jou√©s', '25 quiz jou√©s', '50 quiz jou√©s', '100 quiz jou√©s', '150 quiz jou√©s']
            },
            { 
                id: 'perfect_games', 
                name: 'Perfectionniste', 
                icon: '‚≠ê', 
                levels: [1, 5, 10, 25, 50, 100, 250],
                getProgress: (data) => data.perfectGames || 0,
                getNextTarget: (current) => {
                    const targets = [1, 5, 10, 25, 50, 100, 250];
                    return targets.find(t => t > current) || 250;
                },
                descriptions: ['1 quiz parfait', '5 quiz parfaits', '10 quiz parfaits', '25 quiz parfaits', '50 quiz parfaits', '100 quiz parfaits', '250 quiz parfaits']
            },
            { 
                id: 'streak', 
                name: 'Enflamm√©', 
                icon: 'üî•', 
                levels: [3, 7, 14, 30, 60, 100],
                getProgress: (data) => data.streak || 0,
                getNextTarget: (current) => {
                    const targets = [3, 7, 14, 30, 60, 100];
                    return targets.find(t => t > current) || 100;
                },
                descriptions: ['3 jours', '7 jours', '14 jours', '30 jours', '60 jours', '100 jours']
            },
            { 
                id: 'total_correct', 
                name: 'Centurion', 
                icon: 'üíØ', 
                levels: [50, 100, 500, 1000, 5000],
                getProgress: (data) => data.correctAnswers || 0,
                getNextTarget: (current) => {
                    const targets = [50, 100, 500, 1000, 5000];
                    return targets.find(t => t > current) || 5000;
                },
                descriptions: ['50 bonnes r√©ponses', '100 bonnes r√©ponses', '500 bonnes r√©ponses', '1000 bonnes r√©ponses', '5000 bonnes r√©ponses']
            },
            { 
                id: 'points', 
                name: 'Collectionneur', 
                icon: 'üí∞', 
                levels: [500, 1000, 5000, 10000, 25000, 50000],
                getProgress: (data) => data.points || 0,
                getNextTarget: (current) => {
                    const targets = [500, 1000, 5000, 10000, 25000, 50000];
                    return targets.find(t => t > current) || 50000;
                },
                descriptions: ['500 points', '1000 points', '5000 points', '10000 points', '25000 points', '50000 points']
            },
            // BADGES TH√âMATIQUES
            { 
                id: 'category_francais', 
                name: 'Expert Fran√ßais', 
                icon: 'üìù', 
                levels: [10, 25, 50, 100, 250],
                getProgress: (data) => (data.categoryStats && data.categoryStats['Programme scolaire - Communication fran√ßaise']) ? data.categoryStats['Programme scolaire - Communication fran√ßaise'].correct || 0 : 0,
                getNextTarget: (current) => {
                    const targets = [10, 25, 50, 100, 250];
                    return targets.find(t => t > current) || 250;
                },
                descriptions: ['10 bonnes r√©ponses en Fran√ßais', '25 bonnes r√©ponses en Fran√ßais', '50 bonnes r√©ponses en Fran√ßais', '100 bonnes r√©ponses en Fran√ßais', '250 bonnes r√©ponses en Fran√ßais']
            },
            { 
                id: 'category_maths', 
                name: 'Expert Maths', 
                icon: 'üî¢', 
                levels: [10, 25, 50, 100, 250],
                getProgress: (data) => (data.categoryStats && data.categoryStats['Programme scolaire - Math√©matiques']) ? data.categoryStats['Programme scolaire - Math√©matiques'].correct || 0 : 0,
                getNextTarget: (current) => {
                    const targets = [10, 25, 50, 100, 250];
                    return targets.find(t => t > current) || 250;
                },
                descriptions: ['10 bonnes r√©ponses en Maths', '25 bonnes r√©ponses en Maths', '50 bonnes r√©ponses en Maths', '100 bonnes r√©ponses en Maths', '250 bonnes r√©ponses en Maths']
            },
            { 
                id: 'category_sciences', 
                name: 'Expert Sciences', 
                icon: 'üî¨', 
                levels: [10, 25, 50, 100, 250],
                getProgress: (data) => {
                    if (!data.categoryStats) return 0;
                    let total = 0;
                    for (const [key, value] of Object.entries(data.categoryStats)) {
                        if (key.includes('Sciences') || key.includes('sciences')) {
                            total += value.correct || 0;
                        }
                    }
                    return total;
                },
                getNextTarget: (current) => {
                    const targets = [10, 25, 50, 100, 250];
                    return targets.find(t => t > current) || 250;
                },
                descriptions: ['10 bonnes r√©ponses en Sciences', '25 bonnes r√©ponses en Sciences', '50 bonnes r√©ponses en Sciences', '100 bonnes r√©ponses en Sciences', '250 bonnes r√©ponses en Sciences']
            },
            { 
                id: 'category_creole', 
                name: 'Expert Krey√≤l', 
                icon: 'üó£Ô∏è', 
                levels: [10, 25, 50, 100, 250],
                getProgress: (data) => {
                    if (!data.categoryStats) return 0;
                    let total = 0;
                    for (const [key, value] of Object.entries(data.categoryStats)) {
                        if (key.includes('cr√©ole') || key.includes('Cr√©ole')) {
                            total += value.correct || 0;
                        }
                    }
                    return total;
                },
                getNextTarget: (current) => {
                    const targets = [10, 25, 50, 100, 250];
                    return targets.find(t => t > current) || 250;
                },
                descriptions: ['10 bonnes r√©ponses en Krey√≤l', '25 bonnes r√©ponses en Krey√≤l', '50 bonnes r√©ponses en Krey√≤l', '100 bonnes r√©ponses en Krey√≤l', '250 bonnes r√©ponses en Krey√≤l']
            },
            { 
                id: 'category_culture_haitienne', 
                name: 'Expert Culture Ha√Øtienne', 
                icon: 'üá≠üáπ', 
                levels: [10, 25, 50, 100, 250],
                getProgress: (data) => {
                    if (!data.categoryStats) return 0;
                    let total = 0;
                    for (const [key, value] of Object.entries(data.categoryStats)) {
                        if (key.includes('Culture ha√Øtienne') || key.includes('Culture Ha√Øtienne')) {
                            total += value.correct || 0;
                        }
                    }
                    return total;
                },
                getNextTarget: (current) => {
                    const targets = [10, 25, 50, 100, 250];
                    return targets.find(t => t > current) || 250;
                },
                descriptions: ['10 bonnes r√©ponses en Culture Ha√Øtienne', '25 bonnes r√©ponses en Culture Ha√Øtienne', '50 bonnes r√©ponses en Culture Ha√Øtienne', '100 bonnes r√©ponses en Culture Ha√Øtienne', '250 bonnes r√©ponses en Culture Ha√Øtienne']
            },
            { 
                id: 'category_culture_generale', 
                name: 'Expert Culture G√©n√©rale', 
                icon: 'üåç', 
                levels: [10, 25, 50, 100, 250],
                getProgress: (data) => {
                    if (!data.categoryStats) return 0;
                    let total = 0;
                    for (const [key, value] of Object.entries(data.categoryStats)) {
                        if (key.includes('Culture g√©n√©rale') || key.includes('Culture G√©n√©rale')) {
                            total += value.correct || 0;
                        }
                    }
                    return total;
                },
                getNextTarget: (current) => {
                    const targets = [10, 25, 50, 100, 250];
                    return targets.find(t => t > current) || 250;
                },
                descriptions: ['10 bonnes r√©ponses en Culture G√©n√©rale', '25 bonnes r√©ponses en Culture G√©n√©rale', '50 bonnes r√©ponses en Culture G√©n√©rale', '100 bonnes r√©ponses en Culture G√©n√©rale', '250 bonnes r√©ponses en Culture G√©n√©rale']
            }
        ];

        // D√©fis quotidiens (15 d√©fis vari√©s)
        const DAILY_CHALLENGES = [
            { id: 'perfect', title: 'üéØ Parfait', description: 'Obtiens 10/10 √† un quiz', reward: 200, check: (data) => data.isPerfect },
            { id: 'speed', title: '‚ö° Rapide', description: 'R√©ponds √† 8 questions en moins de 15s chacune', reward: 200, check: (data) => data.fastAnswers >= 8 },
            { id: 'endurance', title: 'üî• Endurant', description: 'Joue 3 quiz d\'affil√©e', reward: 300, check: (data) => data.consecutiveGames >= 3 },
            { id: 'precision', title: 'üß† Savant', description: 'Obtiens 80% minimum sur 2 quiz', reward: 250, check: (data) => data.highAccuracyGames >= 2 },
            { id: 'culture_generale', title: 'üåç √ârudit', description: 'Compl√®te 1 quiz en Culture G√©n√©rale', reward: 150, check: (data) => data.cultureGenerale >= 1 },
            { id: 'haiti_expert', title: 'üá≠üáπ Patriote', description: 'Compl√®te 1 quiz en Culture Ha√Øtienne', reward: 150, check: (data) => data.cultureHaitienne >= 1 },
            { id: 'math_master', title: 'üî¢ Math√©maticien', description: 'Fais 10 bonnes r√©ponses en Maths', reward: 200, check: (data) => data.mathsCorrect >= 10 },
            { id: 'science_fan', title: 'üî¨ Scientifique', description: 'Fais 10 bonnes r√©ponses en Sciences', reward: 200, check: (data) => data.sciencesCorrect >= 10 },
            { id: 'no_mistake', title: 'üíé Impeccable', description: 'Fais un quiz sans aucune erreur', reward: 250, check: (data) => data.noMistake },
            { id: 'explorer', title: 'üó∫Ô∏è Explorateur', description: 'Joue dans 3 th√©matiques diff√©rentes', reward: 300, check: (data) => data.differentCategories >= 3 },
            { id: 'combo_master', title: 'üé≤ Combo Master', description: 'R√©ponds correctement √† 5 questions d\'affil√©e', reward: 200, check: (data) => data.correctStreak >= 5 },
            { id: 'early_bird', title: 'üåÖ L√®ve-t√¥t', description: 'Joue avant 9h du matin', reward: 150, check: (data) => data.earlyBird },
            { id: 'night_owl', title: 'üåô Noctambule', description: 'Joue apr√®s 22h', reward: 150, check: (data) => data.nightOwl },
            { id: 'coins_collector', title: 'üí∞ Collectionneur', description: 'Gagne 100 jetons en une session', reward: 300, check: (data) => data.sessionCoins >= 100 },
            { id: 'unstoppable', title: '‚ö° Inarr√™table', description: 'Joue 5 quiz en une session', reward: 500, check: (data) => data.consecutiveGames >= 5 }
        ];

        let currentDailyChallenge = null;
        let activeDailyChallenge = false; // Le d√©fi doit √™tre activ√© manuellement
        let challengeProgress = { 
            isPerfect: false, 
            fastAnswers: 0, 
            consecutiveGames: 0, 
            highAccuracyGames: 0,
            cultureGenerale: 0,
            cultureHaitienne: 0,
            mathsCorrect: 0,
            sciencesCorrect: 0,
            noMistake: false,
            differentCategories: 0,
            categoriesPlayed: [],
            correctStreak: 0,
            earlyBird: false,
            nightOwl: false,
            sessionCoins: 0
        };

        // Fonction pour chiffrer le code de r√©cup√©ration (SHA-256)
        async function hashRecoveryCode(code) {
            const encoder = new TextEncoder();
            const data = encoder.encode(code);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        function generateRecoveryCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = 'QUIZ';
            for (let i = 0; i < 3; i++) {
                code += '-';
                for (let j = 0; j < 4; j++) {
                    code += chars.charAt(Math.floor(Math.random() * chars.length));
                }
            }
            return code; // Format: QUIZ-A3X9-2K4M-7H8P
        }

        function getLevelInfo(points) {
            return LEVELS.find(l => points >= l.min && points <= l.max) || LEVELS[0];
        }

        function getBadgeLevel(badgeId) {
            const badge = BADGES.find(b => b.id === badgeId);
            if (!badge) return { current: 0, total: 0, progress: 0, nextTarget: 0 };
            
            const progress = badge.getProgress(userData);
            let currentLevel = 0;
            
            // Trouver le niveau actuel en partant du D√âBUT
            for (let i = 0; i < badge.levels.length; i++) {
                if (progress >= badge.levels[i]) {
                    currentLevel = i + 1;
                } else {
                    break; // Arr√™ter d√®s qu'on trouve un niveau non atteint
                }
            }
            
            return { 
                current: currentLevel, 
                total: badge.levels.length,
                progress: progress,
                nextTarget: badge.getNextTarget(progress)
            };
        }

        function getTotalBadgesEarned() {
            let total = 0;
            BADGES.forEach(badge => {
                const level = getBadgeLevel(badge.id);
                // Somme des niveaux accomplis de tous les badges
                total += level.current;
            });
            return total;
        }

        // Initialisation
        async function initApp() {
            userId = localStorage.getItem('quizUserId');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('quizUserId', userId);
            }

            // Charger √©tat de sync
            needsSync = localStorage.getItem('needsSync') === 'true';
            isOnline = navigator.onLine;

            // Listeners online/offline
            window.addEventListener('online', async () => {
                isOnline = true;
                console.log('üåê Connexion r√©tablie !');
                await syncPendingData();
            });

            window.addEventListener('offline', () => {
                isOnline = false;
                console.log('üìµ Connexion perdue - Mode offline');
            });

            loadSettings();
            await loadUserData();
            checkDailyChallenge();
            checkAndResetHearts();
            initAudio();
            updateSyncBadge();
            startHeartRegenTimer(); // NOUVEAU d√©marrer timer r√©g√©n√©ration
            await loadFriendRequests(); // Charger demandes d'amis
            updateFriendsBadge(); // Afficher badge si nouvelles demandes
        }

        function initAudio() {
            if (typeof Tone !== 'undefined') {
                pianoSynth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: 'triangle' },
                    envelope: { attack: 0.02, decay: 0.3, sustain: 0.1, release: 1 }
                }).toDestination();
                pianoSynth.volume.value = -10;

                violinSynth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: 'sawtooth' },
                    envelope: { attack: 0.1, decay: 0.2, sustain: 0.5, release: 0.8 }
                }).toDestination();
                violinSynth.volume.value = -35;
            }
        }

        async function loadUserData() {
            try {
                if (window.firebaseDB && window.firebaseRef && window.firebaseGet) {
                    const userRef = window.firebaseRef(window.firebaseDB, 'users/' + userId);
                    const snapshot = await window.firebaseGet(userRef);
                    
                    if (snapshot.exists()) {
                        userData = snapshot.val();
                        // Migration pour les anciennes donn√©es
                        if (userData.hearts === undefined) userData.hearts = 3;
                        if (userData.lastHeartReset === undefined) userData.lastHeartReset = '';
                        if (userData.lastHeartRegenTime === undefined) userData.lastHeartRegenTime = ''; // NOUVEAU
                        if (userData.badgeProgress === undefined) userData.badgeProgress = {};
                        if (userData.categoryStats === undefined) userData.categoryStats = {};
                        if (userData.purchasedHearts === undefined) userData.purchasedHearts = 0;
                    } else {
                        userData.name = '√ârudit' + Math.floor(Math.random() * 9000 + 1000);
                        const newCode = generateRecoveryCode();
                        userData.recoveryCodeHash = await hashRecoveryCode(newCode);
                        localStorage.setItem('recoveryCodePlain_' + userId, newCode);
                        await saveUserData();
                    }
                    
                    // Migration : si ancien syst√®me (recoveryCode en clair), convertir en hash
                    if (userData.recoveryCode && !userData.recoveryCodeHash) {
                        userData.recoveryCodeHash = await hashRecoveryCode(userData.recoveryCode);
                        localStorage.setItem('recoveryCodePlain_' + userId, userData.recoveryCode);
                        delete userData.recoveryCode;
                        await saveUserData();
                    }
                    
                    // G√©n√©rer code si manquant (migration)
                    if (!userData.recoveryCodeHash) {
                        const newCode = generateRecoveryCode();
                        userData.recoveryCodeHash = await hashRecoveryCode(newCode);
                        localStorage.setItem('recoveryCodePlain_' + userId, newCode);
                        await saveUserData();
                    }
                    
                    previousLevel = getLevelInfo(userData.points).min;
                    updateUI();
                    updateHeartsDisplay();
                }
            } catch (error) {
                console.log('Mode local:', error);
                const localData = localStorage.getItem('userData');
                if (localData) {
                    userData = JSON.parse(localData);
                    if (userData.hearts === undefined) userData.hearts = 3;
                    if (userData.lastHeartReset === undefined) userData.lastHeartReset = '';
                    if (userData.lastHeartRegenTime === undefined) userData.lastHeartRegenTime = ''; // NOUVEAU
                    if (userData.badgeProgress === undefined) userData.badgeProgress = {};
                    if (userData.categoryStats === undefined) userData.categoryStats = {};
                    if (userData.purchasedHearts === undefined) userData.purchasedHearts = 0;
                    // Migration : convertir ancien recoveryCode en hash
                    if (userData.recoveryCode && !userData.recoveryCodeHash) {
                        userData.recoveryCodeHash = await hashRecoveryCode(userData.recoveryCode);
                        localStorage.setItem('recoveryCodePlain_' + userId, userData.recoveryCode);
                        delete userData.recoveryCode;
                        localStorage.setItem('userData', JSON.stringify(userData));
                    }
                    if (!userData.recoveryCodeHash) {
                        const newCode = generateRecoveryCode();
                        userData.recoveryCodeHash = await hashRecoveryCode(newCode);
                        localStorage.setItem('recoveryCodePlain_' + userId, newCode);
                        localStorage.setItem('userData', JSON.stringify(userData));
                    }
                } else {
                    userData.name = '√ârudit' + Math.floor(Math.random() * 9000 + 1000);
                    const newCode = generateRecoveryCode();
                    userData.recoveryCodeHash = await hashRecoveryCode(newCode);
                    localStorage.setItem('recoveryCodePlain_' + userId, newCode);
                }
                updateUI();
                updateHeartsDisplay();
            }
        }

        async function updateLeaderboard() {
            try {
                if (window.firebaseDB && window.firebaseRef && window.firebaseSet) {
                    // Copier seulement les donn√©es publiques vers /leaderboard/
                    const leaderboardData = {
                        name: userData.name,
                        points: userData.points,
                        coins: userData.coins,
                        correctAnswers: userData.correctAnswers || 0,
                        totalAnswers: userData.totalAnswers || 0,
                        totalBadges: getTotalBadgesEarned() // CORRECT : vrai compte badges
                    };
                    const leaderboardRef = window.firebaseRef(window.firebaseDB, 'leaderboard/' + userId);
                    await window.firebaseSet(leaderboardRef, leaderboardData);
                }
            } catch (error) {
                console.log('Erreur mise √† jour leaderboard:', error);
            }
        }

        async function saveUserData() {
            // ===== SYST√àME ANTI-TRICHE =====
            // CORRIG√â : Valeurs max r√©alistes par partie
            const maxPointsPerGame = 120; // 5 pts √ó 10 Q + 2 bonus √ó 10 + 50 perfect
            const maxCoinsPerGame = 120; // 5 jetons √ó 10 Q + 2 bonus √ó 10 + 50 perfect ‚úÖ CORRIG√â
            
            // V√©rifier si les valeurs sont suspectes (marge de s√©curit√© √ó 1.5)
            const totalGames = userData.totalGames || 1; // Au moins 1 pour √©viter division par 0
            const maxPointsTheoriques = maxPointsPerGame * totalGames * 1.5;
            const maxCoinsTheoriques = maxCoinsPerGame * totalGames * 1.5;
            
            if (userData.points > maxPointsTheoriques) {
                console.warn('‚ö†Ô∏è Points suspects d√©tect√©s - R√©initialisation');
                userData.points = Math.floor(maxPointsPerGame * totalGames);
            }
            
            if (userData.coins > maxCoinsTheoriques) {
                console.warn('‚ö†Ô∏è Jetons suspects d√©tect√©s - R√©initialisation');
                userData.coins = Math.floor(maxCoinsPerGame * totalGames);
            }
            // ===== FIN ANTI-TRICHE =====
            
            // TOUJOURS sauvegarder en local D'ABORD (m√™me si Firebase marche)
            localStorage.setItem('userData', JSON.stringify(userData));
            
            // PUIS essayer Firebase si online
            if (isOnline && window.firebaseDB && window.firebaseRef && window.firebaseSet) {
                try {
                    const userRef = window.firebaseRef(window.firebaseDB, 'users/' + userId);
                    await window.firebaseSet(userRef, userData);
                    // Mettre √† jour le leaderboard automatiquement
                    await updateLeaderboard();
                    // Sync r√©ussie !
                    needsSync = false;
                    localStorage.setItem('needsSync', 'false');
                    updateSyncBadge();
                } catch (error) {
                    console.log('Firebase √©chou√©, marqu√© pour sync:', error);
                    // Marquer pour sync plus tard
                    needsSync = true;
                    localStorage.setItem('needsSync', 'true');
                    updateSyncBadge();
                }
            } else {
                // Pas de connexion ou Firebase indisponible
                needsSync = true;
                localStorage.setItem('needsSync', 'true');
                updateSyncBadge();
            }
        }

        function updateSyncBadge() {
            // Mettre √† jour le badge de sync dans le menu
            const syncBadge = document.getElementById('syncBadge');
            if (syncBadge) {
                syncBadge.style.display = needsSync ? 'inline-block' : 'none';
            }
        }

        // ========================================
        // SYST√àME AMIS
        // ========================================

        async function searchUserByName(searchName) {
            if (!isOnline || !window.firebaseDB || !window.firebaseRef || !window.firebaseGet) {
                alert('‚ùå Tu dois √™tre connect√© √† internet pour rechercher des amis.');
                return null;
            }

            if (!searchName || searchName.trim() === '') {
                alert('‚ö†Ô∏è Entre un nom d\'utilisateur');
                return null;
            }

            try {
                const usersRef = window.firebaseRef(window.firebaseDB, 'users');
                const snapshot = await window.firebaseGet(usersRef);
                
                if (!snapshot.exists()) return null;

                const users = snapshot.val();
                const searchLower = searchName.trim().toLowerCase();
                
                // Chercher utilisateur par nom (case insensitive)
                for (const [uid, user] of Object.entries(users)) {
                    if (user.name && user.name.toLowerCase() === searchLower) {
                        // Ne pas retourner soi-m√™me
                        if (uid === userId) {
                            alert('üòÑ C\'est toi ! Tu ne peux pas t\'ajouter comme ami.');
                            return null;
                        }
                        
                        // V√©rifier si d√©j√† ami
                        if (userData.friends && userData.friends[uid]) {
                            alert('‚úÖ ' + user.name + ' est d√©j√† ton ami !');
                            return null;
                        }
                        
                        // V√©rifier si demande d√©j√† envoy√©e
                        if (userData.sentRequests && userData.sentRequests[uid]) {
                            alert('‚è≥ Tu as d√©j√† envoy√© une demande √† ' + user.name);
                            return null;
                        }
                        
                        return { uid: uid, name: user.name, points: user.points || 0 };
                    }
                }
                
                return null;
            } catch (error) {
                console.error('Erreur recherche:', error);
                alert('‚ùå Erreur lors de la recherche');
                return null;
            }
        }

        async function sendFriendRequest(targetUserId, targetUserName) {
            if (!isOnline || !window.firebaseDB || !window.firebaseRef || !window.firebaseSet) {
                alert('‚ùå Tu dois √™tre connect√© √† internet');
                return false;
            }

            try {
                const now = new Date().toISOString();
                
                // Ajouter la demande chez le destinataire
                const targetRequestRef = window.firebaseRef(window.firebaseDB, `users/${targetUserId}/friendRequests/${userId}`);
                await window.firebaseSet(targetRequestRef, {
                    name: userData.name,
                    date: now
                });
                
                // Ajouter dans sentRequests de l'envoyeur
                if (!userData.sentRequests) userData.sentRequests = {};
                userData.sentRequests[targetUserId] = {
                    name: targetUserName,
                    date: now
                };
                
                await saveUserData();
                
                alert('‚úÖ Demande d\'ami envoy√©e √† ' + targetUserName + ' !');
                return true;
            } catch (error) {
                console.error('Erreur envoi demande:', error);
                alert('‚ùå Erreur lors de l\'envoi');
                return false;
            }
        }

        async function acceptFriendRequest(senderId, senderName) {
            if (!isOnline || !window.firebaseDB || !window.firebaseRef || !window.firebaseSet || !window.firebaseRemove) {
                alert('‚ùå Tu dois √™tre connect√© √† internet');
                return false;
            }

            try {
                const now = new Date().toISOString();
                
                // Ajouter dans les amis des deux c√¥t√©s
                if (!userData.friends) userData.friends = {};
                userData.friends[senderId] = {
                    name: senderName,
                    addedDate: now
                };
                
                // Ajouter dans les amis de l'envoyeur
                const senderFriendRef = window.firebaseRef(window.firebaseDB, `users/${senderId}/friends/${userId}`);
                await window.firebaseSet(senderFriendRef, {
                    name: userData.name,
                    addedDate: now
                });
                
                // Supprimer la demande re√ßue
                if (userData.friendRequests && userData.friendRequests[senderId]) {
                    delete userData.friendRequests[senderId];
                }
                const requestRef = window.firebaseRef(window.firebaseDB, `users/${userId}/friendRequests/${senderId}`);
                await window.firebaseRemove(requestRef);
                
                // Supprimer la demande envoy√©e de l'envoyeur
                const sentRequestRef = window.firebaseRef(window.firebaseDB, `users/${senderId}/sentRequests/${userId}`);
                await window.firebaseRemove(sentRequestRef);
                
                await saveUserData();
                
                alert('‚úÖ ' + senderName + ' est maintenant ton ami !');
                return true;
            } catch (error) {
                console.error('Erreur acceptation:', error);
                alert('‚ùå Erreur lors de l\'acceptation');
                return false;
            }
        }

        async function rejectFriendRequest(senderId) {
            if (!isOnline || !window.firebaseDB || !window.firebaseRef || !window.firebaseRemove) {
                alert('‚ùå Tu dois √™tre connect√© √† internet');
                return false;
            }

            try {
                // Supprimer la demande re√ßue
                if (userData.friendRequests && userData.friendRequests[senderId]) {
                    delete userData.friendRequests[senderId];
                }
                const requestRef = window.firebaseRef(window.firebaseDB, `users/${userId}/friendRequests/${senderId}`);
                await window.firebaseRemove(requestRef);
                
                // Supprimer la demande envoy√©e de l'envoyeur
                const sentRequestRef = window.firebaseRef(window.firebaseDB, `users/${senderId}/sentRequests/${userId}`);
                await window.firebaseRemove(sentRequestRef);
                
                await saveUserData();
                
                return true;
            } catch (error) {
                console.error('Erreur refus:', error);
                alert('‚ùå Erreur lors du refus');
                return false;
            }
        }

        async function sendHeartGift(friendId, friendName) {
            // V√©rifier qu'on a au moins 1 c≈ìur
            if (userData.hearts < 1) {
                alert('‚ùå Tu n\'as pas de c≈ìur √† envoyer ! Ach√®tes-en dans la boutique.');
                return false;
            }

            if (!isOnline || !window.firebaseDB || !window.firebaseRef || !window.firebaseSet || !window.firebaseGet) {
                alert('‚ùå Tu dois √™tre connect√© √† internet');
                return false;
            }

            if (!confirm(`üíù Envoyer 1 c≈ìur √† ${friendName} ?\n\nTu as actuellement ${userData.hearts} ‚ù§Ô∏è`)) {
                return false;
            }

            try {
                // R√©cup√©rer les donn√©es de l'ami
                const friendRef = window.firebaseRef(window.firebaseDB, `users/${friendId}`);
                const friendSnapshot = await window.firebaseGet(friendRef);
                
                if (!friendSnapshot.exists()) {
                    alert('‚ùå Ami introuvable');
                    return false;
                }
                
                const friendData = friendSnapshot.val();
                
                // V√©rifier limite 25 c≈ìurs de l'ami
                const friendHearts = friendData.hearts || 0;
                if (friendHearts >= 25) {
                    alert('‚ö†Ô∏è ' + friendName + ' a d√©j√† le maximum de c≈ìurs (25) !');
                    return false;
                }
                
                // Retirer 1 c≈ìur √† soi
                userData.hearts--;
                await saveUserData();
                
                // Ajouter 1 c≈ìur √† l'ami
                const newFriendHearts = Math.min(friendHearts + 1, 25);
                const friendHeartsRef = window.firebaseRef(window.firebaseDB, `users/${friendId}/hearts`);
                await window.firebaseSet(friendHeartsRef, newFriendHearts);
                
                updateHeartsDisplay();
                alert('‚úÖ 1 c≈ìur envoy√© √† ' + friendName + ' ! üíù');
                
                playSound('correct');
                vibrate(50);
                
                return true;
            } catch (error) {
                console.error('Erreur envoi c≈ìur:', error);
                // Restaurer le c≈ìur en cas d'erreur
                userData.hearts++;
                await saveUserData();
                updateHeartsDisplay();
                alert('‚ùå Erreur lors de l\'envoi');
                return false;
            }
        }

        async function loadFriendRequests() {
            if (!isOnline || !window.firebaseDB || !window.firebaseRef || !window.firebaseGet) {
                return;
            }

            try {
                const requestsRef = window.firebaseRef(window.firebaseDB, `users/${userId}/friendRequests`);
                const snapshot = await window.firebaseGet(requestsRef);
                
                if (snapshot.exists()) {
                    userData.friendRequests = snapshot.val();
                } else {
                    userData.friendRequests = {};
                }
            } catch (error) {
                console.error('Erreur chargement demandes:', error);
            }
        }

        // ========================================
        // √âCRANS & MODALS AMIS
        // ========================================

        function showFriendsScreen() {
            hideAllScreens();
            document.querySelector('.friends-screen').classList.add('active');
            updateFriendsDisplay();
        }

        async function updateFriendsDisplay() {
            await loadFriendRequests();
            
            // ‚úÖ Protection null - compatibilit√© anciens comptes
            if (!userData.friendRequests) userData.friendRequests = {};
            if (!userData.friends) userData.friends = {};
            if (!userData.sentRequests) userData.sentRequests = {};
            
            const requestsCount = Object.keys(userData.friendRequests).length;
            const friendsCount = Object.keys(userData.friends).length;
            
            document.getElementById('friendRequestsCount').textContent = requestsCount;
            document.getElementById('friendsCount').textContent = friendsCount;
            
            // Mettre √† jour badge notification
            updateFriendsBadge();
            
            // Afficher les demandes
            const requestsList = document.getElementById('friendRequestsList');
            if (requestsCount === 0) {
                requestsList.innerHTML = '<div class="no-friends">Aucune demande en attente</div>';
            } else {
                requestsList.innerHTML = '';
                for (const [senderId, request] of Object.entries(userData.friendRequests)) {
                    const div = document.createElement('div');
                    div.className = 'friend-request-item';
                    div.innerHTML = `
                        <div class="friend-name">üë§ ${request.name}</div>
                        <div class="friend-actions">
                            <button class="btn btn-small btn-success" onclick="handleAcceptFriend('${senderId}', '${request.name.replace(/'/g, "\\'")}')">‚úÖ Accepter</button>
                            <button class="btn btn-small btn-danger" onclick="handleRejectFriend('${senderId}')">‚ùå Refuser</button>
                        </div>
                    `;
                    requestsList.appendChild(div);
                }
            }
            
            // Afficher les amis
            const friendsList = document.getElementById('friendsList');
            if (friendsCount === 0) {
                friendsList.innerHTML = '<div class="no-friends">Ajoute des amis pour jouer ensemble ! üë•</div>';
            } else {
                friendsList.innerHTML = '';
                for (const [friendId, friend] of Object.entries(userData.friends)) {
                    const div = document.createElement('div');
                    div.className = 'friend-item';
                    div.innerHTML = `
                        <div class="friend-name">üë§ ${friend.name}</div>
                        <button class="btn btn-small btn-primary" onclick="sendHeartGift('${friendId}', '${friend.name.replace(/'/g, "\\'")}')">üíù Envoyer 1 ‚ù§Ô∏è</button>
                    `;
                    friendsList.appendChild(div);
                }
            }
        }

        function showSearchFriendModal() {
            document.getElementById('searchFriendModal').classList.add('active');
            document.getElementById('searchFriendInput').value = '';
            document.getElementById('searchFriendResult').innerHTML = '';
        }

        function closeSearchFriendModal() {
            document.getElementById('searchFriendModal').classList.remove('active');
        }

        async function handleSearchFriend() {
            const searchInput = document.getElementById('searchFriendInput');
            const searchName = searchInput.value.trim();
            const resultDiv = document.getElementById('searchFriendResult');
            
            if (!searchName) {
                resultDiv.innerHTML = '<div style="color: #ef4444;">‚ö†Ô∏è Entre un nom d\'utilisateur</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div style="color: #3b82f6;">üîç Recherche en cours...</div>';
            
            const user = await searchUserByName(searchName);
            
            if (!user) {
                resultDiv.innerHTML = '<div style="color: #ef4444;">‚ùå Utilisateur introuvable</div>';
            } else {
                resultDiv.innerHTML = `
                    <div class="search-result">
                        <div class="search-result-name">üë§ ${user.name}</div>
                        <div class="search-result-points">‚≠ê ${user.points} points</div>
                        <button class="btn btn-primary" onclick="sendFriendRequest('${user.uid}', '${user.name.replace(/'/g, "\\'")}'); closeSearchFriendModal();">
                            ‚ûï Ajouter en ami
                        </button>
                    </div>
                `;
            }
        }

        async function handleAcceptFriend(senderId, senderName) {
            const success = await acceptFriendRequest(senderId, senderName);
            if (success) {
                updateFriendsDisplay();
            }
        }

        async function handleRejectFriend(senderId) {
            const success = await rejectFriendRequest(senderId);
            if (success) {
                updateFriendsDisplay();
            }
        }

        function updateFriendsBadge() {
            const badge = document.getElementById('friendsBadge');
            const requestsCount = userData.friendRequests ? Object.keys(userData.friendRequests).length : 0;
            
            if (badge) {
                badge.style.display = requestsCount > 0 ? 'inline-block' : 'none';
                if (requestsCount > 0) {
                    badge.textContent = requestsCount;
                }
            }
        }

        async function syncPendingData() {
            // Synchroniser les donn√©es en attente
            if (!needsSync) return;
            
            console.log('Tentative de synchronisation...');
            await saveUserData(); // R√©-essayer de sauvegarder
        }

        function updateUI() {
            const level = getLevelInfo(userData.points);
            const displayText = level.medal + ' ' + level.name;
            
            document.getElementById('profileName').textContent = userData.name;
            document.getElementById('profileAvatar').textContent = userData.name.charAt(0).toUpperCase();
            document.getElementById('profileLevel').textContent = displayText;
            document.getElementById('userPoints').textContent = userData.points;
            document.getElementById('userCoins').textContent = userData.coins;
            
            const accuracy = userData.totalAnswers > 0 
                ? Math.round((userData.correctAnswers / userData.totalAnswers) * 100) 
                : 0;
            document.getElementById('userAccuracy').textContent = accuracy + '%';
        }

        function playSound(type) {
            if (!soundEnabled || !pianoSynth) return;
            
            Tone.start();
            if (type === 'correct') {
                pianoSynth.triggerAttackRelease(['C5', 'E5', 'G5'], '8n');
            } else if (type === 'incorrect') {
                pianoSynth.triggerAttackRelease(['F3', 'Ab3'], '4n');
            }
        }

        function playCelebration() {
            if (!musicEnabled || !pianoSynth) return;
            
            Tone.start();
            const now = Tone.now();
            pianoSynth.triggerAttackRelease('C5', '8n', now);
            pianoSynth.triggerAttackRelease('E5', '8n', now + 0.1);
            pianoSynth.triggerAttackRelease('G5', '8n', now + 0.2);
            pianoSynth.triggerAttackRelease('C6', '4n', now + 0.3);
        }

        function vibrate(pattern) {
            if (vibrationEnabled && navigator.vibrate) {
                navigator.vibrate(pattern);
            }
        }

        function createConfetti() {
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.background = ['#fbbf24', '#3b82f6', '#ef4444', '#10b981'][Math.floor(Math.random() * 4)];
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 30);
            }
        }

        // ===== NOUVELLE GESTION DES C≈íURS =====
        
        // CORRIG√â : R√©g√©n√©ration 1 c≈ìur/1h (max 3 gratuits)
        function checkAndResetHearts() {
            const now = new Date();
            const lastRegenTime = userData.lastHeartRegenTime ? new Date(userData.lastHeartRegenTime) : null;
            
            // Calculer combien de c≈ìurs gratuits le joueur a
            const freeHearts = Math.max(0, Math.min(3, userData.hearts - (userData.purchasedHearts || 0)));
            
            // Si le joueur a moins de 3 c≈ìurs gratuits
            if (freeHearts < 3 && lastRegenTime) {
                const hoursPassed = (now - lastRegenTime) / (1000 * 60 * 60);
                const heartsToAdd = Math.floor(hoursPassed);
                
                if (heartsToAdd > 0) {
                    const newFreeHearts = Math.min(3, freeHearts + heartsToAdd);
                    userData.hearts = newFreeHearts + (userData.purchasedHearts || 0);
                    userData.lastHeartRegenTime = now.toISOString();
                    saveUserData();
                    updateHeartsDisplay();
                }
            } else if (!lastRegenTime && freeHearts < 3) {
                // Premier lancement ou migration : initialiser le timer
                userData.lastHeartRegenTime = now.toISOString();
                saveUserData();
            }
            
            updateHeartsRegenTimer(); // Afficher timer
        }
        
        // NOUVEAU : Timer r√©g√©n√©ration visible
        function startHeartRegenTimer() {
            // Mettre √† jour toutes les 1 minute
            heartRegenInterval = setInterval(() => {
                checkAndResetHearts();
                updateHeartsRegenTimer();
            }, 60000); // 1 minute
            
            // Mettre √† jour imm√©diatement
            updateHeartsRegenTimer();
        }
        
        function updateHeartsRegenTimer() {
            const timerEl = document.getElementById('heartsRegenTimer');
            if (!timerEl) return;
            
            const freeHearts = Math.max(0, Math.min(3, userData.hearts - (userData.purchasedHearts || 0)));
            
            if (freeHearts >= 3) {
                timerEl.textContent = '‚úÖ C≈ìurs gratuits au max';
                timerEl.style.color = '#10b981';
                return;
            }
            
            const now = new Date();
            const lastRegenTime = userData.lastHeartRegenTime ? new Date(userData.lastHeartRegenTime) : now;
            const nextRegenTime = new Date(lastRegenTime.getTime() + 60 * 60 * 1000); // +1h
            const timeLeft = nextRegenTime - now;
            
            if (timeLeft <= 0) {
                timerEl.textContent = '‚è±Ô∏è R√©g√©n√©ration disponible...';
                timerEl.style.color = '#10b981';
                checkAndResetHearts(); // R√©g√©n√©rer imm√©diatement
            } else {
                const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                
                timerEl.textContent = `‚è±Ô∏è Prochain c≈ìur dans ${hours}h ${minutes}min ${seconds}s`;
                timerEl.style.color = '#6b7280';
            }
        }

        function updateHeartsDisplay() {
            const hearts = userData.hearts || 0;
            const heartsHTML = '‚ù§Ô∏è'.repeat(Math.min(hearts, 3)) + 'üñ§'.repeat(Math.max(0, 3 - hearts));
            
            const heartsDisplayEl = document.getElementById('heartsDisplay');
            if (heartsDisplayEl) {
                heartsDisplayEl.innerHTML = `
                    <span>${heartsHTML}</span>
                    <span style="margin-left: 8px; font-size: 22px;" title="Boutique">üõí</span>
                    <div class="hearts-count" id="heartsCount">(${hearts} ${hearts > 1 ? 'vies' : 'vie'})</div>
                `;
            }
            
            const quizHeartsEl = document.getElementById('quizHearts');
            if (quizHeartsEl && document.querySelector('.quiz-screen').classList.contains('active')) {
                quizHeartsEl.innerHTML = `
                    ${heartsHTML}
                    <span style="font-size: 12px; color: var(--text-secondary); margin-left: 5px;">(${hearts})</span>
                `;
            }
            
            updateHeartsRegenTimer(); // Mettre √† jour timer
        }

        function loseHeart() {
            if (userData.hearts > 0) {
                userData.hearts--;
                
                // Si on perd un c≈ìur au-dessus de 3, c'est un c≈ìur achet√©
                if (userData.purchasedHearts > 0 && userData.hearts >= 3) {
                    userData.purchasedHearts--;
                }
                
                // PROTECTION : Ne jamais aller en n√©gatif
                if (userData.hearts < 0) userData.hearts = 0;
                if (userData.purchasedHearts < 0) userData.purchasedHearts = 0;
                
                // D√©marrer timer de r√©g√©n√©ration si on passe en-dessous de 3 c≈ìurs gratuits
                const freeHearts = Math.max(0, Math.min(3, userData.hearts - (userData.purchasedHearts || 0)));
                if (freeHearts < 3 && !userData.lastHeartRegenTime) {
                    userData.lastHeartRegenTime = new Date().toISOString();
                }
                
                updateHeartsDisplay();
                saveUserData();
                
                if (userData.hearts === 0) {
                    showNoHeartsModal();
                }
            }
        }

        function showNoHeartsModal() {
            clearInterval(timerInterval);
            
            const overlay = document.createElement('div');
            overlay.className = 'no-hearts-overlay';
            overlay.innerHTML = `
                <div class="no-hearts-card">
                    <div class="no-hearts-icon">üíî</div>
                    <div class="no-hearts-title">Plus de vies !</div>
                    <div class="no-hearts-message">
                        Tu as perdu toutes tes vies. Ach√®te des c≈ìurs pour continuer √† jouer !
                    </div>
                    <button class="btn btn-primary" onclick="goToHeartsShop()">‚ù§Ô∏è Acheter des vies</button>
                    <button class="btn btn-secondary" onclick="quitQuizNoHearts()" style="margin-top: 10px;">üè† Retour au menu</button>
                </div>
            `;
            
            document.body.appendChild(overlay);
        }

        function showHeartsShopModal() {
            const shopHeartsEl = document.getElementById('shopHeartsCount');
            const shopCoinsEl = document.getElementById('shopCoinsCount');
            if (shopHeartsEl) shopHeartsEl.textContent = userData.hearts || 0;
            if (shopCoinsEl) shopCoinsEl.textContent = userData.coins || 0;
            
            document.getElementById('heartsShopModal').classList.add('active');
            updateHeartsRegenTimer(); // Afficher timer dans modal
        }

        function closeHeartsShopModal() {
            document.getElementById('heartsShopModal').classList.remove('active');
            
            // Si on √©tait en pause quiz, reprendre
            if (quizPaused && fromShop) {
                fromShop = false;
                resumeQuiz();
            }
        }

        function openShopFromQuiz() {
            pauseQuiz();
            fromShop = true;
            showHeartsShopModal();
        }

        function showPrecisionDetails() {
            const correct = userData.correctAnswers || 0;
            const total = userData.totalAnswers || 0;
            const percent = total > 0 ? Math.round((correct / total) * 100) : 0;
            
            document.getElementById('precisionCorrect').textContent = correct;
            document.getElementById('precisionTotal').textContent = total;
            document.getElementById('precisionPercent').textContent = percent + '%';
            
            document.getElementById('precisionModal').classList.add('active');
        }

        function closePrecisionModal() {
            document.getElementById('precisionModal').classList.remove('active');
        }

        function showPointsDetails() {
            // Points de base
            document.getElementById('correctCountDetail').textContent = `${correctCount} bonnes r√©ponses √ó 5 pts`;
            document.getElementById('basePointsDetail').textContent = `+${sessionPoints} pts`;
            
            // Points bonus breakdown
            let bonusHTML = '';
            let fastCount = 0;
            
            // Compter les r√©ponses rapides (on ne les a pas track√©es individuellement, donc approximation)
            if (sessionBonusPoints > 0) {
                const perfectBonus = correctCount === currentQuestions.length ? 50 : 0;
                const speedBonus = sessionBonusPoints - perfectBonus;
                fastCount = speedBonus / 2;
                
                if (fastCount > 0) {
                    bonusHTML += `
                        <div class="points-item">
                            <span>${Math.floor(fastCount)} r√©ponses rapides √ó 2 pts</span>
                            <span>+${speedBonus} pts</span>
                        </div>
                    `;
                }
                
                if (perfectBonus > 0) {
                    bonusHTML += `
                        <div class="points-item">
                            <span>Quiz parfait üéâ</span>
                            <span>+${perfectBonus} pts</span>
                        </div>
                    `;
                }
            }
            
            if (!bonusHTML) {
                bonusHTML = '<div class="points-item"><span>Aucun bonus</span><span>+0 pts</span></div>';
            }
            
            document.getElementById('bonusPointsBreakdown').innerHTML = bonusHTML;
            document.getElementById('totalPointsDetail').textContent = `+${sessionPoints + sessionBonusPoints} pts`;
            
            document.getElementById('pointsDetailsModal').classList.add('active');
        }

        function closePointsDetailsModal() {
            document.getElementById('pointsDetailsModal').classList.remove('active');
        }

        function showCoinsDetails() {
            // Jetons de base
            const baseCoinsPerQuestion = 5;
            const coinBonusPerFast = 2;
            
            let detailsHTML = '<div class="points-section"><div class="points-section-title">Jetons de Base</div>';
            detailsHTML += `<div class="points-item"><span>${correctCount} bonnes r√©ponses √ó ${baseCoinsPerQuestion} ü™ô</span><span>+${correctCount * baseCoinsPerQuestion} ü™ô</span></div>`;
            detailsHTML += '</div>';
            
            // Calcul approximatif des jetons rapides (en excluant le d√©fi et le bonus parfait)
            const perfectCoins = correctCount === currentQuestions.length ? 50 : 0;
            const totalCoinsWithoutPerfectAndChallenge = sessionCoins - perfectCoins - sessionChallengeReward;
            const baseCoins = correctCount * baseCoinsPerQuestion;
            const fastCoins = totalCoinsWithoutPerfectAndChallenge - baseCoins;
            const fastCount = fastCoins / coinBonusPerFast;
            
            if (fastCoins > 0 || perfectCoins > 0) {
                detailsHTML += '<div class="points-section"><div class="points-section-title">Jetons Bonus</div>';
                
                if (fastCoins > 0) {
                    detailsHTML += `<div class="points-item"><span>${Math.floor(fastCount)} r√©ponses rapides √ó ${coinBonusPerFast} ü™ô</span><span>+${fastCoins} ü™ô</span></div>`;
                }
                
                if (perfectCoins > 0) {
                    detailsHTML += `<div class="points-item"><span>Quiz parfait üéâ</span><span>+${perfectCoins} ü™ô</span></div>`;
                }
                
                detailsHTML += '</div>';
            }
            
            // ‚úÖ AFFICHER R√âCOMPENSE D√âFI S√âPAR√âMENT
            if (sessionChallengeReward > 0) {
                detailsHTML += '<div class="points-section"><div class="points-section-title">R√©compense D√©fi</div>';
                detailsHTML += `<div class="points-item"><span>D√©fi quotidien compl√©t√© ‚ö°</span><span>+${sessionChallengeReward} ü™ô</span></div>`;
                detailsHTML += '</div>';
            }
            
            document.getElementById('coinsDetailsBreakdown').innerHTML = detailsHTML;
            document.getElementById('totalCoinsDetail').textContent = `+${sessionCoins} ü™ô`;
            document.getElementById('coinsDetailsModal').classList.add('active');
        }

        function closeCoinsDetailsModal() {
            document.getElementById('coinsDetailsModal').classList.remove('active');
        }

        function goToHeartsShop() {
            document.querySelector('.no-hearts-overlay')?.remove();
            showHeartsShopModal();
        }

        function quitQuizNoHearts() {
            document.querySelector('.no-hearts-overlay')?.remove();
            quitQuiz();
        }

        function showHeartsShop() {
            hideAllScreens();
            document.querySelector('.hearts-shop-screen').classList.add('active');
            const shopHeartsEl = document.getElementById('shopHeartsCount');
            const shopCoinsEl = document.getElementById('shopCoinsCount');
            if (shopHeartsEl) shopHeartsEl.textContent = userData.hearts || 0;
            if (shopCoinsEl) shopCoinsEl.textContent = userData.coins || 0;
        }

        // CORRIG√â : Limite 25 c≈ìurs max
        function buyHearts(amount, price) {
            // PROTECTION : V√©rifier limite 25 c≈ìurs
            if (userData.hearts >= 25) {
                vibrate([100, 50, 100]);
                alert(`‚ùå Niveau d'achat maximum atteint !\n\nTu as d√©j√† ${userData.hearts} c≈ìurs (limite: 25).`);
                return;
            }
            
            // V√©rifier si l'achat d√©passerait 25
            if (userData.hearts + amount > 25) {
                const available = 25 - userData.hearts;
                vibrate([100, 50, 100]);
                alert(`‚ùå Tu ne peux acheter que ${available} c≈ìur(s) pour atteindre le maximum de 25.`);
                return;
            }
            
            if (userData.coins >= price) {
                userData.coins -= price;
                userData.hearts = (userData.hearts || 0) + amount;
                userData.purchasedHearts = (userData.purchasedHearts || 0) + amount;
                saveUserData();
                updateUI();
                updateHeartsDisplay();
                
                // Mettre √† jour le modal
                const shopHeartsEl = document.getElementById('shopHeartsCount');
                const shopCoinsEl = document.getElementById('shopCoinsCount');
                if (shopHeartsEl) shopHeartsEl.textContent = userData.hearts;
                if (shopCoinsEl) shopCoinsEl.textContent = userData.coins;
                
                vibrate(50);
                
                // Message de succ√®s sans fermer le modal
                setTimeout(() => {
                    alert(`‚úÖ Tu as achet√© ${amount} ${amount > 1 ? 'vies' : 'vie'} !`);
                }, 100);
            } else {
                vibrate([100, 50, 100]);
                alert(`‚ùå Pas assez de jetons ! Il te manque ${price - userData.coins} jetons.`);
            }
        }

        // Gestion du streak
        function updateStreak() {
            const today = new Date().toDateString();
            const lastPlayed = userData.lastPlayed;
            
            if (!lastPlayed) {
                // Premier jour
                userData.streak = 1;
            } else {
                const lastDate = new Date(lastPlayed);
                const todayDate = new Date(today);
                const diffTime = todayDate - lastDate;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) {
                    // M√™me jour, ne rien changer
                    return;
                } else if (diffDays === 1) {
                    // Jour cons√©cutif
                    userData.streak++;
                } else {
                    // Streak cass√©
                    userData.streak = 1;
                }
            }
            
            userData.lastPlayed = today;
        }

        // Difficult√© adaptative
        function getDifficultyDistribution() {
            const levelInfo = getLevelInfo(userData.points);
            const levelName = levelInfo.name.split(' ')[0]; // Prend juste le nom sans les √©toiles
            
            const distributions = {
                'D√©butant': { 'Facile': 60, 'Moyen': 30, 'Difficile': 10 },
                'Apprenti': { 'Facile': 40, 'Moyen': 40, 'Difficile': 20 },
                '√âtudiant': { 'Facile': 30, 'Moyen': 50, 'Difficile': 20 },
                'Savant': { 'Facile': 20, 'Moyen': 50, 'Difficile': 30 },
                'Expert': { 'Facile': 10, 'Moyen': 40, 'Difficile': 50 },
                'Ma√Ætre': { 'Facile': 5, 'Moyen': 35, 'Difficile': 60 },
                'L√©gende': { 'Facile': 0, 'Moyen': 30, 'Difficile': 70 }
            };
            
            return distributions[levelName] || distributions['D√©butant'];
        }

        let askedQuestionsIds = JSON.parse(localStorage.getItem('askedQuestionsIds') || '[]');

        function selectQuestionsByDifficulty(questions, count) {
            if (questions.length === 0) return [];
            
            const distribution = getDifficultyDistribution();
            const selected = [];
            
            // S√©parer par difficult√© (exclure d√©j√† pos√©es)
            let easy = questions.filter(q => q.difficulty === 'Facile' && !askedQuestionsIds.includes(q.id));
            let medium = questions.filter(q => q.difficulty === 'Moyen' && !askedQuestionsIds.includes(q.id));
            let hard = questions.filter(q => q.difficulty === 'Difficile' && !askedQuestionsIds.includes(q.id));
            
            // Si TOUTES les questions ont √©t√© pos√©es ‚Üí RESET et recommencer
            if (easy.length === 0 && medium.length === 0 && hard.length === 0) {
                askedQuestionsIds = [];
                localStorage.setItem('askedQuestionsIds', JSON.stringify(askedQuestionsIds));
                easy = questions.filter(q => q.difficulty === 'Facile');
                medium = questions.filter(q => q.difficulty === 'Moyen');
                hard = questions.filter(q => q.difficulty === 'Difficile');
            }
            
            // Calculer nombres de questions par difficult√©
            let numEasy = Math.round(count * distribution['Facile'] / 100);
            let numMedium = Math.round(count * distribution['Moyen'] / 100);
            let numHard = count - numEasy - numMedium;
            
            // Prendre ce qu'on peut de chaque difficult√©
            const selectedEasy = shuffleArray(easy).slice(0, Math.min(numEasy, easy.length));
            const selectedMedium = shuffleArray(medium).slice(0, Math.min(numMedium, medium.length));
            const selectedHard = shuffleArray(hard).slice(0, Math.min(numHard, hard.length));
            
            selected.push(...selectedEasy);
            selected.push(...selectedMedium);
            selected.push(...selectedHard);
            
            // Si pas assez ‚Üí Compl√©ter avec N'IMPORTE quelle question non s√©lectionn√©e
            while (selected.length < count) {
                const remaining = questions.filter(q => !selected.some(s => s.id === q.id));
                if (remaining.length === 0) break; // Plus de questions dispo
                
                const randomQuestion = remaining[Math.floor(Math.random() * remaining.length)];
                selected.push(randomQuestion);
            }
            
            // Ajouter les IDs aux questions pos√©es
            selected.forEach(q => {
                if (!askedQuestionsIds.includes(q.id)) {
                    askedQuestionsIds.push(q.id);
                }
            });
            localStorage.setItem('askedQuestionsIds', JSON.stringify(askedQuestionsIds));
            
            return shuffleArray(selected);
        }

        // Param√®tres
        function loadSettings() {
            // Mode nuit
            darkModeEnabled = localStorage.getItem('darkModeEnabled') === 'true';
            document.getElementById('darkModeToggle').classList.toggle('active', darkModeEnabled);
            if (darkModeEnabled) {
                document.body.classList.add('dark-mode');
            }

            soundEnabled = localStorage.getItem('soundEnabled') === 'true';
            document.getElementById('soundToggle').classList.toggle('active', soundEnabled);

            vibrationEnabled = localStorage.getItem('vibrationEnabled') !== 'false';
            document.getElementById('vibrationToggle').classList.toggle('active', vibrationEnabled);

            timerDuration = parseInt(localStorage.getItem('timerDuration') || '30');
            document.getElementById('timerDuration').value = timerDuration;
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            localStorage.setItem('soundEnabled', soundEnabled);
            document.getElementById('soundToggle').classList.toggle('active', soundEnabled);
        }

        function toggleVibration() {
            vibrationEnabled = !vibrationEnabled;
            localStorage.setItem('vibrationEnabled', vibrationEnabled);
            document.getElementById('vibrationToggle').classList.toggle('active', vibrationEnabled);
        }

        function toggleDarkMode() {
            darkModeEnabled = !darkModeEnabled;
            localStorage.setItem('darkModeEnabled', darkModeEnabled);
            document.getElementById('darkModeToggle').classList.toggle('active', darkModeEnabled);
            document.body.classList.toggle('dark-mode', darkModeEnabled);
        }

        function saveTimerDuration() {
            timerDuration = parseInt(document.getElementById('timerDuration').value);
            localStorage.setItem('timerDuration', timerDuration);
        }

        function changeName() {
            const name = document.getElementById('nameInput').value.trim();
            if (!name || name.length < 2) {
                alert('Le nom doit contenir au moins 2 caract√®res');
                return;
            }
            if (name.length > 20) {
                alert('Le nom ne peut pas d√©passer 20 caract√®res');
                return;
            }
            userData.name = name;
            saveUserData();
            updateUI();
            document.getElementById('nameInput').value = '';
            alert('Nom chang√© avec succ√®s ! ‚úÖ');
        }

        function resetData() {
            if (confirm('Voulez-vous vraiment r√©initialiser toutes vos donn√©es ?')) {
                userData = {
                    name: '√ârudit' + Math.floor(Math.random() * 9000 + 1000),
                    points: 0,
                    coins: 0,
                    hearts: 3,
                    purchasedHearts: 0,
                    lastHeartReset: '',
                    lastHeartRegenTime: '', // NOUVEAU
                    totalGames: 0,
                    correctAnswers: 0,
                    totalAnswers: 0,
                    streak: 0,
                    lastPlayed: '',
                    level: 1,
                    perfectGames: 0,
                    badges: {},
                    badgeProgress: {},
                    categoryStats: {},
                    dailyChallengeCompleted: false,
                    lastChallengeDate: '',
                    recoveryCode: generateRecoveryCode()
                };
                askedQuestionsIds = [];
                saveUserData();
                updateUI();
                updateHeartsDisplay();
                alert('Donn√©es r√©initialis√©es ! üîÑ');
            }
        }

        function copyRecoveryCode() {
            const plainCode = localStorage.getItem('recoveryCodePlain_' + userId);
            const code = plainCode || '****-****-****-****';
            const input = document.getElementById('recoveryCodeDisplay');
            
            if (!plainCode) {
                alert('‚ùå Code de r√©cup√©ration introuvable. Contacte le support.');
                return;
            }
            
            // M√©thode 1 : Select + copy (marche mieux sur mobile)
            try {
                input.select();
                input.setSelectionRange(0, 99999); // Pour mobile
                document.execCommand('copy');
                alert('‚úÖ Code de r√©cup√©ration copi√© !');
                vibrate(50);
            } catch (err) {
                // M√©thode 2 : Clipboard API (fallback)
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(code).then(() => {
                        alert('‚úÖ Code de r√©cup√©ration copi√© !');
                        vibrate(50);
                    }).catch(() => {
                        alert('üìã Ton code : ' + code + '\n\nCopie-le manuellement');
                    });
                } else {
                    alert('üìã Ton code : ' + code + '\n\nCopie-le manuellement');
                }
            }
        }

        function showRestoreModal() {
            document.getElementById('restoreModal').classList.add('active');
            document.getElementById('restoreCodeInput').value = '';
        }

        function closeRestoreModal() {
            document.getElementById('restoreModal').classList.remove('active');
        }

        async function restoreAccount() {
            const code = document.getElementById('restoreCodeInput').value.trim().toUpperCase();
            
            if (!code || code.length < 10) {
                alert('‚ùå Code invalide. Format: QUIZ-XXXX-XXXX-XXXX');
                return;
            }

            try {
                // Hacher le code entr√© par l'utilisateur
                const codeHash = await hashRecoveryCode(code);
                
                // Chercher dans Firebase par recoveryCodeHash
                if (window.firebaseDB && window.firebaseRef && window.firebaseGet) {
                    const usersRef = window.firebaseRef(window.firebaseDB, 'users');
                    const snapshot = await window.firebaseGet(usersRef);
                    
                    if (snapshot.exists()) {
                        let foundUser = null;
                        let foundUserId = null;
                        
                        snapshot.forEach((child) => {
                            const user = child.val();
                            // Comparer SOIT le hash (nouveaux comptes) SOIT le code en clair (anciens comptes)
                            if (user.recoveryCodeHash === codeHash || user.recoveryCode === code) {
                                foundUser = user;
                                foundUserId = child.key;
                            }
                        });
                        
                        if (foundUser) {
                            // Compte trouv√© !
                            userId = foundUserId;
                            userData = foundUser;
                            localStorage.setItem('quizUserId', userId);
                            localStorage.setItem('userData', JSON.stringify(userData));
                            // Sauvegarder le code en clair dans localStorage pour ce compte
                            localStorage.setItem('recoveryCodePlain_' + userId, code);
                            
                            closeRestoreModal();
                            updateUI();
                            updateHeartsDisplay();
                            alert('‚úÖ Compte restaur√© avec succ√®s ! Bienvenue ' + userData.name + ' !');
                            showMenu();
                        } else {
                            alert('‚ùå Code introuvable. V√©rifie ton code de sauvegarde.');
                        }
                    } else {
                        alert('‚ùå Aucun compte trouv√©.');
                    }
                } else {
                    alert('‚ùå Connexion Firebase requise pour restaurer un compte.');
                }
            } catch (error) {
                console.error('Erreur restauration:', error);
                alert('‚ùå Erreur lors de la restauration. R√©essaie plus tard.');
            }
        }

        function showSettings() {
            fromSettings = document.querySelector('.quiz-screen').classList.contains('active');
            
            // D√©tecter d'o√π on vient (ajouter friends-screen)
            if (document.querySelector('.profile-screen').classList.contains('active')) {
                returnToScreen = 'profile';
            } else if (document.querySelector('.leaderboard-screen').classList.contains('active')) {
                returnToScreen = 'leaderboard';
            } else if (document.querySelector('.levels-screen').classList.contains('active')) {
                returnToScreen = 'levels';
            } else if (document.querySelector('.daily-challenge-screen').classList.contains('active')) {
                returnToScreen = 'daily-challenge';
            } else if (document.querySelector('.category-screen').classList.contains('active')) {
                returnToScreen = 'category';
            } else if (document.querySelector('.result-screen').classList.contains('active')) {
                returnToScreen = 'result';
            } else if (document.querySelector('.friends-screen').classList.contains('active')) {
                returnToScreen = 'friends';
            } else {
                returnToScreen = 'menu';
            }
            
            if (fromSettings) {
                pauseQuiz();
            }
            hideAllScreens();
            document.querySelector('.settings-screen').classList.add('active');
        }

        function showSettingsFromPause() {
            hideAllScreens();
            document.querySelector('.settings-screen').classList.add('active');
            fromSettings = true;
            returnToScreen = 'pause';
        }

        function closeSettings() {
            hideAllScreens();
            if (returnToScreen === 'pause') {
                document.querySelector('.pause-screen').classList.add('active');
            } else if (returnToScreen === 'leaderboard') {
                document.querySelector('.leaderboard-screen').classList.add('active');
            } else if (returnToScreen === 'profile') {
                document.querySelector('.profile-screen').classList.add('active');
            } else if (returnToScreen === 'levels') {
                document.querySelector('.levels-screen').classList.add('active');
            } else if (returnToScreen === 'daily-challenge') {
                document.querySelector('.daily-challenge-screen').classList.add('active');
            } else if (returnToScreen === 'category') {
                document.querySelector('.category-screen').classList.add('active');
            } else if (returnToScreen === 'result') {
                document.querySelector('.result-screen').classList.add('active');
            } else if (returnToScreen === 'friends') {
                document.querySelector('.friends-screen').classList.add('active');
            } else {
                showMenu();
            }
        }

        // Navigation
        function closeWelcome() {
            hideAllScreens();
            showMenu();
        }

        function showMenu() {
            hideAllScreens();
            document.querySelector('.menu-screen').classList.add('active');
            document.getElementById('settingsIcon').style.display = 'block';
            updateUI();
            updateHeartsDisplay();
        }

        function showProfile() {
            hideAllScreens();
            document.querySelector('.profile-screen').classList.add('active');
            updateProfileScreen();
        }

        function updateProfileScreen() {
            const level = getLevelInfo(userData.points);
            const nextLevel = LEVELS.find(l => l.min > userData.points) || LEVELS[LEVELS.length - 1];
            const progress = ((userData.points - level.min) / (level.max - level.min)) * 100;
            
            document.getElementById('profileAvatarModal').textContent = userData.name.charAt(0).toUpperCase();
            document.getElementById('profileNameModal').textContent = userData.name;
            document.getElementById('profileLevelModal').textContent = level.medal + ' ' + level.name;
            document.getElementById('levelProgressFill').style.width = progress + '%';
            document.getElementById('currentLevelPoints').textContent = level.min + ' pts';
            document.getElementById('nextLevelPoints').textContent = level.max + ' pts';
            document.getElementById('nextLevelName').textContent = nextLevel.medal + ' ' + nextLevel.name;
            document.getElementById('pointsToNext').textContent = 'Encore ' + (nextLevel.min - userData.points) + ' points !';
            
            document.getElementById('totalGamesProfile').textContent = userData.totalGames;
            document.getElementById('correctAnswersProfile').textContent = userData.correctAnswers;
            document.getElementById('wrongAnswersProfile').textContent = (userData.totalAnswers - userData.correctAnswers);
            
            const accuracy = userData.totalAnswers > 0 ? Math.round((userData.correctAnswers / userData.totalAnswers) * 100) : 0;
            document.getElementById('accuracyProfile').textContent = accuracy + '%';
            document.getElementById('streakProfile').textContent = userData.streak + ' jours üî•';
            document.getElementById('coinsProfile').textContent = userData.coins + ' ü™ô';
            
            const totalBadges = getTotalBadgesEarned();
            document.getElementById('totalBadgesCount').textContent = totalBadges;
            
            // Afficher le code de r√©cup√©ration depuis localStorage
            const recoveryCodeEl = document.getElementById('recoveryCodeDisplay');
            if (recoveryCodeEl) {
                const plainCode = localStorage.getItem('recoveryCodePlain_' + userId);
                recoveryCodeEl.value = plainCode || '****-****-****-****';
            }
            
            updateBadgesDisplay();
        }

        function updateBadgesDisplay() {
            const grid = document.getElementById('badgesGrid');
            grid.innerHTML = '';
            
            BADGES.forEach(badge => {
                const levelInfo = getBadgeLevel(badge.id);
                const isUnlocked = levelInfo.current > 0;
                
                const progressPercent = levelInfo.current < badge.levels.length 
                    ? (levelInfo.progress / levelInfo.nextTarget) * 100 
                    : 100;
                
                const div = document.createElement('div');
                div.className = 'badge-container ' + (isUnlocked ? 'unlocked' : 'locked');
                
                // Afficher la description du niveau qu'on essaie d'atteindre (le prochain)
                // Si on a compl√©t√© 2 niveaux, levelInfo.current = 2, on affiche description[2] (le 3e niveau)
                const descriptionIndex = Math.min(levelInfo.current, badge.levels.length - 1);
                const description = badge.descriptions[descriptionIndex];
                
                const progressText = levelInfo.current < badge.levels.length
                    ? `${levelInfo.progress}/${levelInfo.nextTarget}`
                    : 'MAX';
                
                div.innerHTML = `
                    <div class="badge-icon">${isUnlocked ? badge.icon : 'üîí'}</div>
                    <div class="badge-name">${badge.name} ${levelInfo.current > 0 ? `(${levelInfo.current}/${badge.levels.length})` : ''}</div>
                    <div class="badge-progress">${description}</div>
                    <div class="badge-progress" style="margin-top: 4px; font-weight: 600; color: #3b82f6;">${progressText}</div>
                    <div class="progress-mini">
                        <div class="progress-mini-bar" style="width: ${progressPercent}%"></div>
                    </div>
                `;
                grid.appendChild(div);
            });
        }

        function showLevels() {
            hideAllScreens();
            document.querySelector('.levels-screen').classList.add('active');
            updateLevelsDisplay();
        }

        function updateLevelsDisplay() {
            const list = document.getElementById('levelsList');
            const currentLevel = getLevelInfo(userData.points);
            
            list.innerHTML = LEVELS.map(level => {
                const isCurrent = level.min === currentLevel.min;
                return `
                    <div class="level-item ${isCurrent ? 'current' : ''}">
                        <div class="level-medal">${level.medal}</div>
                        <div class="level-details">
                            <div class="level-name">${level.name}</div>
                            <div class="level-range">${level.min} - ${level.max} points</div>
                        </div>
                        ${isCurrent ? '<span style="color: #3b82f6; font-weight: bold;">‚Üê Tu es ici</span>' : ''}
                    </div>
                `;
            }).join('');
        }

        function checkDailyChallenge() {
            const today = new Date().toDateString();
            if (userData.lastChallengeDate !== today) {
                const randomChallenge = DAILY_CHALLENGES[Math.floor(Math.random() * DAILY_CHALLENGES.length)];
                currentDailyChallenge = randomChallenge;
                userData.dailyChallengeCompleted = false;
                document.getElementById('challengeBadge').style.display = 'inline-block';
            }
        }

        function showDailyChallenge() {
            hideAllScreens();
            document.querySelector('.daily-challenge-screen').classList.add('active');
            updateDailyChallengeDisplay();
        }

        function updateDailyChallengeDisplay() {
            const card = document.getElementById('dailyChallengeCard');
            if (!currentDailyChallenge || userData.dailyChallengeCompleted) {
                card.innerHTML = `
                    <div class="challenge-icon">‚úÖ</div>
                    <div class="challenge-title">D√©fi Compl√©t√© !</div>
                    <div class="challenge-description">Reviens demain pour un nouveau d√©fi</div>
                    <button class="btn btn-primary" onclick="showMenu()">Retour au Menu</button>
                `;
            } else {
                const now = new Date();
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0);
                const timeLeft = tomorrow - now;
                const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                
                card.innerHTML = `
                    <div class="challenge-icon">‚ö°</div>
                    <div class="challenge-title">${currentDailyChallenge.title}</div>
                    <div class="challenge-description">${currentDailyChallenge.description}</div>
                    <div class="challenge-reward">
                        <strong>R√©compense :</strong> ${currentDailyChallenge.reward} ü™ô
                    </div>
                    <div class="challenge-timer">‚è±Ô∏è ${hours}h ${minutes}min ${seconds}s restantes</div>
                    <button class="btn btn-primary" onclick="startDailyQuiz()">Relever le D√©fi üöÄ</button>
                    <button class="btn btn-secondary" onclick="showMenu()" style="margin-top: 10px;">Retour</button>
                `;
            }
        }

        function startDailyQuiz() {
            // ‚úÖ ACTIVER LE D√âFI
            activeDailyChallenge = true;
            
            const now = new Date();
            const hour = now.getHours();
            
            challengeProgress = { 
                isPerfect: false, 
                fastAnswers: 0, 
                consecutiveGames: 0, 
                highAccuracyGames: 0,
                cultureGenerale: 0,
                cultureHaitienne: 0,
                mathsCorrect: 0,
                sciencesCorrect: 0,
                noMistake: false,
                differentCategories: 0,
                categoriesPlayed: [],
                correctStreak: 0,
                earlyBird: hour < 9,
                nightOwl: hour >= 22,
                sessionCoins: 0
            };
            
            // ‚úÖ Lancer la bonne cat√©gorie selon le d√©fi
            if (!currentDailyChallenge) {
                startQuiz('all', 'D√©fi Quotidien', 'mixte');
                return;
            }
            
            switch (currentDailyChallenge.id) {
                case 'math_master':
                    startQuiz('Programme scolaire - Math√©matiques', 'Math√©matiques', 'maths');
                    break;
                case 'science_fan':
                    startQuiz('Programme scolaire - Sciences', 'Sciences', 'sciences');
                    break;
                case 'haiti_expert':
                    startQuiz('Culture ha√Øtienne', 'Culture Ha√Øtienne', 'culture-haitienne');
                    break;
                case 'culture_generale':
                    startQuiz('Culture g√©n√©rale', 'Culture G√©n√©rale', 'culture-generale');
                    break;
                default:
                    // D√©fis g√©n√©raux (parfait, rapide, endurant, savant, explorateur...) ‚Üí mode mixte
                    startQuiz('all', 'D√©fi Quotidien', 'mixte');
            }
        }

        function showCategories() {
            hideAllScreens();
            document.querySelector('.category-screen').classList.add('active');
            populateCategories();
        }

        async function showLeaderboard() {
            // D√©tecter d'o√π on vient
            if (document.querySelector('.result-screen').classList.contains('active')) {
                returnToScreen = 'result';
            } else if (document.querySelector('.profile-screen').classList.contains('active')) {
                returnToScreen = 'profile';
            } else {
                returnToScreen = 'menu';
            }
            hideAllScreens();
            document.querySelector('.leaderboard-screen').classList.add('active');
            await loadLeaderboard();
        }

        function goBackFromLeaderboard() {
            hideAllScreens();
            if (returnToScreen === 'result') {
                document.querySelector('.result-screen').classList.add('active');
            } else if (returnToScreen === 'profile') {
                document.querySelector('.profile-screen').classList.add('active');
            } else {
                showMenu();
            }
        }

        function hideAllScreens() {
            document.querySelectorAll('.menu-screen, .category-screen, .quiz-screen, .result-screen, .leaderboard-screen, .settings-screen, .welcome-screen, .pause-screen, .profile-screen, .levels-screen, .daily-challenge-screen, .friends-screen, .level-up-screen')
                .forEach(screen => screen.classList.remove('active'));
        }

        function populateCategories() {
            const grid = document.getElementById('categoryGrid');
            grid.innerHTML = `
                <div class="category-card" data-symbols="üé≤ ‚ö° üî• üéØ ‚ú®" onclick="startQuiz('all', 'Mode Mixte', 'mixte')">
                    <h3>üé≤ Mode Mixte</h3>
                    <p>Challenge ultime ! Teste toutes tes connaissances ! üî•</p>
                </div>
                <div class="category-card" data-symbols="‚úçÔ∏è üìñ üí¨ üî§ üìù" onclick="startQuiz('Programme scolaire - Communication fran√ßaise', 'Fran√ßais', 'francais')">
                    <h3>üìù Fran√ßais</h3>
                    <p>Ma√Ætrise la langue de Moli√®re avec √©l√©gance ! üìö</p>
                </div>
                <div class="category-card" data-symbols="œÄ ‚àö ‚àë ‚àû √∑ √ó" onclick="startQuiz('Programme scolaire - Math√©matiques', 'Math√©matiques', 'maths')">
                    <h3>üî¢ Math√©matiques</h3>
                    <p>D√©veloppe ta logique et deviens un as du calcul ! üßÆ</p>
                </div>
                <div class="category-card" data-symbols="‚öõÔ∏è üî¨ üß™ üå°Ô∏è ‚ö°" onclick="startQuiz('Programme scolaire - Sciences', 'Sciences', 'sciences')">
                    <h3>üî¨ Sciences</h3>
                    <p>Explore les myst√®res de l'univers ! üî≠</p>
                </div>
                <div class="category-card" data-symbols="üó£Ô∏è üá≠üáπ üí¨ üåü" onclick="startQuiz('Programme scolaire - Communication cr√©ole', 'Krey√≤l', 'creole')">
                    <h3>üó£Ô∏è Krey√≤l</h3>
                    <p>Pale krey√≤l ak fy√®te, ranf√≤se konesans ou ! üåü</p>
                </div>
                <div class="category-card" data-symbols="üá≠üáπ üèõÔ∏è üé≠ ü•Å üå∫" onclick="startQuiz('Culture ha√Øtienne', 'Culture Ha√Øtienne', 'culture-haitienne')">
                    <h3>üá≠üáπ Culture Ha√Øtienne</h3>
                    <p>Plonge dans la richesse de notre patrimoine ! üå∫</p>
                </div>
                <div class="category-card" data-symbols="üåç üéì üí° üß† üìö" onclick="startQuiz('Culture g√©n√©rale', 'Culture G√©n√©rale', 'culture-generale')">
                    <h3>üåç Culture G√©n√©rale</h3>
                    <p>√âlargis tes horizons, deviens cultiv√© ! üåü</p>
                </div>
            `;
        }

        async function loadQuestions() {
            if (allQuestions.length > 0) return true;
            
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}?key=${GOOGLE_SHEETS_API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                
                const rows = data.values.slice(1);
                allQuestions = rows.map(row => ({
                    id: row[0],
                    category: row[1],
                    question: row[2],
                    options: [row[3], row[4], row[5], row[6]],
                    correctAnswer: row[7],
                    explanation: row[8],
                    difficulty: row[9] || 'Moyen'
                }));
                
                // Sauvegarder dans le cache
                localStorage.setItem('questionsCache', JSON.stringify(allQuestions));
                localStorage.setItem('questionsCacheDate', new Date().toISOString());
                
                return true;
            } catch (error) {
                console.error('Erreur chargement questions:', error);
                
                // Essayer de charger depuis le cache
                const cachedQuestions = localStorage.getItem('questionsCache');
                if (cachedQuestions) {
                    allQuestions = JSON.parse(cachedQuestions);
                    const cacheDate = localStorage.getItem('questionsCacheDate');
                    alert('üì± Mode hors ligne activ√©\nDerni√®re mise √† jour: ' + new Date(cacheDate).toLocaleDateString());
                    return true;
                }
                
                alert('‚ùå Erreur de connexion et aucun cache disponible.\nV√©rifiez votre connexion internet.');
                return false;
            }
        }

        async function startQuiz(category, displayName, badgeClass) {
            // V√©rifier les c≈ìurs
            if (userData.hearts <= 0) {
                showNoHeartsModal();
                return;
            }

            if (!await loadQuestions()) return;

            currentCategory = displayName;
            currentCategoryKey = category; // STOCKER LA VRAIE CAT√âGORIE GOOGLE SHEETS !
            currentCategoryBadge = badgeClass;

            let filtered = allQuestions;
            if (category !== 'all') {
                filtered = allQuestions.filter(q => q.category.includes(category));
            }

            const numQuestions = Math.min(filtered.length, 10);
            currentQuestions = selectQuestionsByDifficulty(filtered, numQuestions);
            
            // PROTECTION : V√©rifier qu'on a bien des questions
            if (!currentQuestions || currentQuestions.length === 0) {
                alert('‚ùå Aucune question disponible pour cette th√©matique. R√©essaie plus tard !');
                showMenu();
                return;
            }
            
            currentQuestionIndex = 0;
            correctCount = 0;
            sessionPoints = 0;
            sessionCoins = 0;
            sessionBonusPoints = 0;
            sessionChallengeReward = 0; // ‚úÖ Reset r√©compense d√©fi
            pointsBeforeQuiz = userData.points; // Sauvegarder points AVANT le quiz
            
            // ‚úÖ Tracking d√©fi si activ√© (cumulatif - ne pas √©craser noMistake si d√©j√† false)
            if (activeDailyChallenge) {
                // noMistake reste false si d√©j√† √©chou√© dans un quiz pr√©c√©dent
                if (challengeProgress.noMistake !== false) {
                    challengeProgress.noMistake = true; // Optimiste pour ce quiz
                }
                
                // Tracker cat√©gorie jou√©e pour "Explorateur"
                const catKey = currentCategoryKey === 'all' ? 'Mixte' : currentCategoryKey;
                if (!challengeProgress.categoriesPlayed.includes(catKey)) {
                    challengeProgress.categoriesPlayed.push(catKey);
                    challengeProgress.differentCategories = challengeProgress.categoriesPlayed.length;
                }
                
                challengeProgress.consecutiveGames++;
            }

            hideAllScreens();
            document.querySelector('.quiz-screen').classList.add('active');
            document.getElementById('settingsIcon').style.display = 'none';
            
            const badge = document.getElementById('categoryBadge');
            badge.textContent = `üìö ${currentCategory}`;
            badge.className = `category-badge badge-${badgeClass}`;
            
            document.getElementById('totalQ').textContent = numQuestions;
            
            updateHeartsDisplay();
            showQuestion();
        }

        function showQuestion() {
            // PROTECTION : Si aucune question disponible
            if (!currentQuestions || currentQuestions.length === 0) {
                alert('‚ùå Aucune question disponible. Retour au menu.');
                showMenu();
                return;
            }
            
            if (currentQuestionIndex >= currentQuestions.length) {
                showResults();
                return;
            }

            const question = currentQuestions[currentQuestionIndex];
            
            document.getElementById('currentQ').textContent = currentQuestionIndex + 1;
            document.getElementById('progressBar').style.width = ((currentQuestionIndex + 1) / currentQuestions.length * 100) + '%';
            document.getElementById('questionText').textContent = question.question;
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('explanationCard').classList.remove('show');

            const optionsDiv = document.getElementById('options');
            optionsDiv.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                optionDiv.textContent = option;
                optionDiv.onclick = () => selectAnswer(index);
                optionsDiv.appendChild(optionDiv);
            });

            startTimer();
        }

        function selectAnswer(selectedIndex) {
            clearInterval(timerInterval);
            
            const question = currentQuestions[currentQuestionIndex];
            const correctIndex = ['A', 'B', 'C', 'D'].indexOf(question.correctAnswer);
            const options = document.querySelectorAll('.option');
            
            options.forEach(opt => opt.onclick = null);
            
            const isCorrect = selectedIndex === correctIndex;
            if (selectedIndex !== -1) {
                options[selectedIndex].classList.add(isCorrect ? 'correct' : 'incorrect');
            }
            if (!isCorrect || selectedIndex === -1) {
                options[correctIndex].classList.add('correct');
            }
            
            document.getElementById('explanationText').textContent = question.explanation;
            document.getElementById('explanationCard').classList.add('show');
            
            if (isCorrect) {
                playSound('correct');
                vibrate(50);
                correctCount++;
                
                const basePoints = 5;
                const speedBonus = timeLeft > (timerDuration - 15) ? 2 : 0;
                sessionPoints += basePoints;
                sessionBonusPoints += speedBonus;
                
                // ‚úÖ D√âJ√Ä CORRECT : 5 jetons base + 2 bonus
                const baseCoins = 5;
                const coinBonus = timeLeft > (timerDuration - 15) ? 2 : 0;
                sessionCoins += (baseCoins + coinBonus);
                
                if (timeLeft > (timerDuration - 15)) {
                    challengeProgress.fastAnswers++;
                }
                
                // ‚úÖ TRACKING D√âFIS SI ACTIV√â
                if (activeDailyChallenge) {
                    challengeProgress.correctStreak++;
                    challengeProgress.sessionCoins = sessionCoins;
                    
                    // Tracker cat√©gories pour d√©fis sp√©cifiques
                    const cat = question.category.toLowerCase();
                    if (cat.includes('math√©matiques') || cat.includes('maths')) {
                        challengeProgress.mathsCorrect++;
                    }
                    if (cat.includes('sciences')) {
                        challengeProgress.sciencesCorrect++;
                    }
                    if (cat.includes('culture ha√Øtienne')) {
                        challengeProgress.cultureHaitienne++;
                    }
                    if (cat.includes('culture g√©n√©rale')) {
                        challengeProgress.cultureGenerale++;
                    }
                }
            } else {
                playSound('incorrect');
                vibrate([100, 50, 100]);
                
                // Perdre un c≈ìur
                loseHeart();
                
                // ‚úÖ TRACKING D√âFIS : reset streak et marquer erreur
                if (activeDailyChallenge) {
                    challengeProgress.correctStreak = 0;
                    challengeProgress.noMistake = false;
                }
            }
            
            userData.totalAnswers++;
            if (isCorrect) userData.correctAnswers++;
            
            // Tracker stats par cat√©gorie
            const questionCategory = question.category;
            if (!userData.categoryStats) userData.categoryStats = {};
            if (!userData.categoryStats[questionCategory]) {
                userData.categoryStats[questionCategory] = { correct: 0, total: 0 };
            }
            userData.categoryStats[questionCategory].total++;
            if (isCorrect) userData.categoryStats[questionCategory].correct++;
            
            document.getElementById('nextBtn').style.display = 'block';
        }

        function nextQuestion() {
            currentQuestionIndex++;
            showQuestion();
        }

        function startTimer() {
            timeLeft = timerDuration;
            const timerEl = document.getElementById('timer');
            timerEl.textContent = timeLeft;
            timerEl.classList.remove('warning');
            
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (quizPaused) return;
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    vibrate([150, 100, 150]);
                    selectAnswer(-1);
                    return;
                }
                
                timeLeft--;
                timerEl.textContent = timeLeft;
                
                if (timeLeft === 10) {
                    timerEl.classList.add('warning');
                    vibrate(30);
                }
                
                if (timeLeft < 10 && timeLeft > 0) {
                    vibrate(20);
                }
            }, 1000);
        }

        function pauseQuiz() {
            quizPaused = true;
            pausedTime = timeLeft;
            clearInterval(timerInterval);
            hideAllScreens();
            document.querySelector('.pause-screen').classList.add('active');
        }

        function resumeQuiz() {
            quizPaused = false;
            hideAllScreens();
            document.querySelector('.quiz-screen').classList.add('active');
            timeLeft = pausedTime;
            startTimer();
        }

        function restartQuiz() {
            currentQuestionIndex = 0;
            correctCount = 0;
            sessionPoints = 0;
            sessionCoins = 0;
            sessionBonusPoints = 0;
            quizPaused = false;
            askedQuestionsIds = []; // RESET pour avoir nouvelles questions
            pointsBeforeQuiz = userData.points; // Sauvegarder points AVANT
            challengeProgress = { isPerfect: false, fastAnswers: 0, consecutiveGames: 0, highAccuracyGames: 0 }; // Reset
            
            // Utiliser la VRAIE cat√©gorie Google Sheets stock√©e !
            let filtered = allQuestions;
            if (currentCategoryKey !== 'all') {
                filtered = allQuestions.filter(q => q.category.includes(currentCategoryKey));
            }
            
            const numQuestions = Math.min(filtered.length, 10);
            currentQuestions = selectQuestionsByDifficulty(filtered, numQuestions);
            
            // PROTECTION : V√©rifier qu'on a bien des questions
            if (!currentQuestions || currentQuestions.length === 0) {
                alert('‚ùå Aucune question disponible. Retour au menu.');
                showMenu();
                return;
            }
            
            hideAllScreens();
            document.querySelector('.quiz-screen').classList.add('active');
            showQuestion();
        }

        function quitQuiz() {
            quizPaused = false;
            clearInterval(timerInterval);
            showMenu();
        }

        function changeThemeFromPause() {
            quizPaused = false;
            clearInterval(timerInterval);
            hideAllScreens();
            document.querySelector('.category-screen').classList.add('active');
            document.getElementById('settingsIcon').style.display = 'block';
        }

        function showResults() {
            clearInterval(timerInterval);
            
            // PROTECTION : Si 0 questions, ne rien faire
            if (!currentQuestions || currentQuestions.length === 0) {
                alert('‚ùå Erreur : Aucune question charg√©e. Retour au menu.');
                showMenu();
                return;
            }
            
            const isPerfect = correctCount === currentQuestions.length && currentQuestions.length > 0;
            
            // ‚úÖ TRACKER D√âFI SEULEMENT SI ACTIV√â - Cumulatif entre quiz
            if (activeDailyChallenge) {
                // isPerfect : vrai seulement si CE quiz est parfait
                if (isPerfect) challengeProgress.isPerfect = true;
                
                // noMistake : reste false si une erreur a √©t√© faite dans n'importe quel quiz
                if (!isPerfect && challengeProgress.noMistake) {
                    challengeProgress.noMistake = false;
                }
                
                const accuracy = (correctCount / currentQuestions.length) * 100;
                if (accuracy >= 80) {
                    challengeProgress.highAccuracyGames++;
                }
            }
            
            // Mettre √† jour le streak
            updateStreak();
            
            userData.totalGames++;
            userData.points += sessionPoints + sessionBonusPoints;
            userData.coins += sessionCoins;
            
            if (isPerfect) {
                const perfectBonus = 50;
                sessionBonusPoints += perfectBonus;
                sessionCoins += 50;
                userData.points += perfectBonus;
                userData.coins += 50;
                userData.perfectGames = (userData.perfectGames || 0) + 1;
            }
            
            const newLevel = getLevelInfo(userData.points);
            const oldLevel = getLevelInfo(previousLevel);
            
            // ‚úÖ V√âRIFIER D√âFI SEULEMENT SI ACTIV√â
            sessionChallengeReward = 0;
            if (activeDailyChallenge && currentDailyChallenge && currentDailyChallenge.check(challengeProgress)) {
                userData.dailyChallengeCompleted = true;
                userData.lastChallengeDate = new Date().toDateString();
                sessionChallengeReward = currentDailyChallenge.reward;
                userData.coins += sessionChallengeReward;
                sessionCoins += sessionChallengeReward;
                document.getElementById('challengeBadge').style.display = 'none';
                activeDailyChallenge = false;
            }
            
            saveUserData();
            
            const levelBeforeQuiz = getLevelInfo(pointsBeforeQuiz);
            const levelAfterQuiz = getLevelInfo(userData.points);
            
            if (levelAfterQuiz.min > levelBeforeQuiz.min) {
                showLevelUpScreen(levelAfterQuiz);
            } else {
                showResultsScreen();
            }
        }

        function showLevelUpScreen(newLevel) {
            hideAllScreens();
            document.querySelector('.level-up-screen').classList.add('active');
            document.getElementById('levelUpIcon').textContent = newLevel.medal;
            document.getElementById('levelUpTitle').textContent = 'F√©licitations !';
            
            const messages = [
                'Tu es maintenant ' + newLevel.name + ' !',
                'Incroyable ! Bienvenue parmi les ' + newLevel.name + 's !',
                'Magistral ! Tu es d√©sormais ' + newLevel.name + ' !',
                'Bravo ! Tu as atteint le niveau ' + newLevel.name + ' !'
            ];
            document.getElementById('levelUpMessage').textContent = messages[Math.floor(Math.random() * messages.length)];
            
            playCelebration();
            vibrate([100, 50, 100, 50, 100, 50, 100]);
            createConfetti();
            
            previousLevel = newLevel.min;
        }

        function closeLevelUp() {
            showResultsScreen();
        }

        function showResultsScreen() {
            hideAllScreens();
            document.querySelector('.result-screen').classList.add('active');
            document.getElementById('settingsIcon').style.display = 'block';
            
            const percentage = (correctCount / currentQuestions.length) * 100;
            let icon = 'üéâ';
            let message = 'Excellent travail !';
            if (percentage < 50) {
                icon = 'üí™';
                message = 'Continue √† t\'entra√Æner !';
            } else if (percentage < 80) {
                icon = 'üëç';
                message = 'Bon travail !';
            }
            
            const level = getLevelInfo(userData.points);
            
            document.getElementById('resultIcon').textContent = icon;
            document.getElementById('finalPoints').textContent = userData.points;
            document.getElementById('resultText').textContent = message;
            document.getElementById('correctAnswers').textContent = `${correctCount}/${currentQuestions.length}`;
            document.getElementById('pointsGained').textContent = '+' + sessionPoints;
            document.getElementById('bonusPoints').textContent = '+' + sessionBonusPoints + ' (bonus)';
            document.getElementById('coinsGained').textContent = '+' + sessionCoins;
            document.getElementById('newLevel').textContent = level.medal + ' ' + level.name;
        }

        async function loadLeaderboard() {
            const list = document.getElementById('leaderboardList');
            const yourRankSection = document.getElementById('yourRankSection');
            list.innerHTML = '<div style="text-align:center; padding:20px; color:#64748b;">Chargement...</div>';
            
            try {
                if (!window.firebaseDB) {
                    throw new Error('Firebase non disponible');
                }
                
                // Lire depuis /leaderboard/ au lieu de /users/ pour la s√©curit√©
                const leaderboardRef = window.firebaseRef(window.firebaseDB, 'leaderboard');
                const snapshot = await window.firebaseGet(leaderboardRef);
                
                if (!snapshot.exists()) {
                    // Leaderboard vide ‚Üí Ajouter l'utilisateur actuel
                    await updateLeaderboard();
                    list.innerHTML = `
                        <div class="leaderboard-item you">
                            <div class="rank gold">1</div>
                            <div class="player-info">
                                <div class="player-name">${getLevelInfo(userData.points).medal} ${userData.name} (Toi)</div>
                                <div class="player-stats">${userData.points} pts ‚Ä¢ ${userData.coins} ü™ô</div>
                            </div>
                        </div>
                    `;
                    yourRankSection.style.display = 'none';
                    return;
                }
                
                const users = [];
                snapshot.forEach((child) => {
                    const user = child.val();
                    users.push({ ...user, id: child.key });
                });
                
                users.sort((a, b) => b.points - a.points);
                
                const top10 = users.slice(0, 10);
                const yourRank = users.findIndex(u => u.id === userId) + 1;
                
                list.innerHTML = top10.map((user, index) => {
                    const level = getLevelInfo(user.points);
                    const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
                    const isYou = user.id === userId;
                    return `
                        <div class="leaderboard-item ${isYou ? 'you' : ''}" onclick="showPlayerDetails('${user.id}', '${user.name}', ${user.points}, ${user.correctAnswers || 0}, ${user.totalAnswers || 0}, ${user.totalBadges || 0})">
                            <div class="rank ${rankClass}">${index + 1}</div>
                            <div class="player-info">
                                <div class="player-name">${level.medal} ${user.name} ${isYou ? '(Toi)' : ''}</div>
                                <div class="player-stats">${user.points} pts ‚Ä¢ ${user.coins} ü™ô</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                if (yourRank > 10) {
                    const yourData = users[yourRank - 1];
                    const pointsToTop10 = top10[9].points - yourData.points + 1;
                    yourRankSection.style.display = 'block';
                    document.getElementById('yourRankInfo').textContent = `#${yourRank} - ${yourData.name}`;
                    document.getElementById('yourRankStats').textContent = `${yourData.points} pts ‚Ä¢ ${yourData.coins} ü™ô`;
                    document.getElementById('yourRankMessage').textContent = `‚Üë Continue ! Plus que ${pointsToTop10} pts pour le Top 10 !`;
                } else {
                    yourRankSection.style.display = 'none';
                }
                
            } catch (error) {
                console.error('Erreur classement:', error);
                list.innerHTML = '<div style="text-align:center; padding:20px; color:#ef4444;">‚ùå Connexion requise pour voir le classement global</div>';
            }
        }

        // CORRIG√â : Afficher vrai nombre de badges pour autres joueurs
        function showPlayerDetails(playerId, playerName, points, correct, total, totalBadges) {
            const level = getLevelInfo(points);
            const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;
            
            // ‚úÖ CORRECTION : Utiliser totalBadges depuis Firebase
            let badgesCount = totalBadges || 0;
            
            // Si c'est l'utilisateur actuel, utiliser les vraies donn√©es locales
            if (playerId === userId) {
                badgesCount = getTotalBadgesEarned();
            }
            
            document.getElementById('detailsAvatar').textContent = playerName.charAt(0).toUpperCase();
            document.getElementById('detailsName').textContent = playerName;
            document.getElementById('detailsLevel').textContent = level.medal + ' ' + level.name;
            document.getElementById('detailsPoints').textContent = points;
            document.getElementById('detailsAccuracy').textContent = accuracy + '%';
            document.getElementById('detailsBadges').textContent = badgesCount + ' üèÖ';
            
            document.querySelector('.player-details-modal').classList.add('active');
        }

        function closePlayerDetails() {
            document.querySelector('.player-details-modal').classList.remove('active');
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
    </script>
    <!-- Precision Details Modal -->
    <div class="precision-modal" id="precisionModal">
        <div class="modal-overlay" onclick="closePrecisionModal()">
            <div class="precision-modal-card" onclick="event.stopPropagation()">
                <div class="precision-modal-title">üìä Pr√©cision</div>
                <div class="precision-detail">
                    <strong id="precisionCorrect">0</strong> bonnes r√©ponses<br>
                    sur <strong id="precisionTotal">0</strong> questions
                </div>
                <div style="font-size: 32px; font-weight: bold; color: #3b82f6; margin: 20px 0;">
                    <span id="precisionPercent">0%</span>
                </div>
                <button class="btn btn-primary" onclick="closePrecisionModal()">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Points Details Modal -->
    <div class="points-details-modal" id="pointsDetailsModal">
        <div class="modal-overlay" onclick="closePointsDetailsModal()">
            <div class="points-details-card" onclick="event.stopPropagation()">
                <div class="points-details-title">üí∞ D√©tail des Points</div>
                
                <div class="points-section">
                    <div class="points-section-title">Points de Base</div>
                    <div class="points-item">
                        <span id="correctCountDetail">0</span>
                        <span id="basePointsDetail">+0 pts</span>
                    </div>
                </div>

                <div class="points-section">
                    <div class="points-section-title">Points Bonus</div>
                    <div id="bonusPointsBreakdown"></div>
                </div>

                <div class="points-total">
                    TOTAL : <span id="totalPointsDetail">+0 pts</span>
                </div>

                <button class="btn btn-primary" onclick="closePointsDetailsModal()" style="margin-top: 20px;">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Coins Details Modal -->
    <div class="points-details-modal" id="coinsDetailsModal">
        <div class="modal-overlay" onclick="closeCoinsDetailsModal()">
            <div class="points-details-card" onclick="event.stopPropagation()">
                <div class="points-details-title">ü™ô D√©tail des Jetons</div>
                
                <div id="coinsDetailsBreakdown"></div>

                <div class="points-total">
                    TOTAL : <span id="totalCoinsDetail">+0 ü™ô</span>
                </div>

                <button class="btn btn-primary" onclick="closeCoinsDetailsModal()" style="margin-top: 20px;">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Hearts Shop Modal -->
    <div class="hearts-shop-modal" id="heartsShopModal">
        <div class="modal-overlay" onclick="closeHeartsShopModal()">
            <div class="hearts-shop-modal-card" onclick="event.stopPropagation()">
                <div class="hearts-shop-card">
                    <div class="shop-hearts-display">‚ù§Ô∏è</div>
                    <div class="shop-title">Boutique de Vies</div>
                    <div class="shop-description">Ach√®te des c≈ìurs pour continuer √† jouer !</div>
                    <div style="margin-bottom: 20px;">
                        <strong>Vies actuelles :</strong> <span id="shopHeartsCount">3</span> ‚ù§Ô∏è<br>
                        <strong>Jetons disponibles :</strong> <span id="shopCoinsCount">0</span> ü™ô
                    </div>
                    <div class="hearts-regen-timer" id="heartsRegenTimer">‚è±Ô∏è Chargement...</div>
                </div>
                <div class="hearts-packs">
                    <div class="pack-card" onclick="buyHearts(1, 150)">
                        <div class="pack-hearts">‚ù§Ô∏è</div>
                        <div style="font-weight: 600; margin-bottom: 5px;">1 Vie</div>
                        <div class="pack-price">150 ü™ô</div>
                    </div>
                    <div class="pack-card" onclick="buyHearts(3, 400)">
                        <div class="pack-hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                        <div style="font-weight: 600; margin-bottom: 5px;">3 Vies</div>
                        <div class="pack-price">400 ü™ô</div>
                        <div style="font-size: 11px; color: #10b981; margin-top: 5px;">√âconomise 50 jetons !</div>
                    </div>
                    <div class="pack-card" onclick="buyHearts(5, 600)">
                        <div class="pack-hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                        <div style="font-weight: 600; margin-bottom: 5px;">5 Vies</div>
                        <div class="pack-price">600 ü™ô</div>
                        <div style="font-size: 11px; color: #10b981; margin-top: 5px;">√âconomise 150 jetons !</div>
                    </div>
                    <div class="pack-card" onclick="buyHearts(10, 1200)">
                        <div class="pack-hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è<br>‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                        <div style="font-weight: 600; margin-bottom: 5px;">10 Vies</div>
                        <div class="pack-price">1200 ü™ô</div>
                        <div style="font-size: 11px; color: #10b981; margin-top: 5px;">√âconomise 300 jetons !</div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="closeHeartsShopModal()" style="margin-top: 15px;">‚Üê Retour</button>
            </div>
        </div>
    </div>

    <!-- Search Friend Modal -->
    <div class="points-details-modal" id="searchFriendModal">
        <div class="modal-overlay" onclick="closeSearchFriendModal()">
            <div class="points-details-card" onclick="event.stopPropagation()">
                <h2 style="text-align: center; margin-bottom: 20px; color: var(--text-primary);">üîç Rechercher un ami</h2>
                <div style="margin-bottom: 20px;">
                    <input 
                        type="text" 
                        id="searchFriendInput" 
                        placeholder="Nom d'utilisateur exact..." 
                        style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 16px; background: var(--bg-secondary); color: var(--text-primary); box-sizing: border-box;"
                        onkeypress="if(event.key === 'Enter') handleSearchFriend()"
                    >
                </div>
                <div id="searchFriendResult" style="min-height: 60px; margin-bottom: 20px;"></div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="handleSearchFriend()">üîç Rechercher</button>
                    <button class="btn btn-secondary" onclick="closeSearchFriendModal()">‚Üê Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Restore Account Modal -->
    <div class="restore-modal" id="restoreModal">
        <div class="modal-overlay" onclick="closeRestoreModal()">
            <div class="restore-modal-card" onclick="event.stopPropagation()">
                <div class="restore-modal-title">üîë Restaurer mon compte</div>
                <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 20px; text-align: center;">
                    Entre ton code de sauvegarde pour r√©cup√©rer ton compte
                </div>
                <input type="text" id="restoreCodeInput" placeholder="QUIZ-XXXX-XXXX-XXXX" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 16px; text-align: center; font-weight: bold; letter-spacing: 1px; margin-bottom: 20px; text-transform: uppercase; background: var(--input-bg); color: var(--text-primary);">
                <button class="btn btn-primary" onclick="restoreAccount()" style="margin-bottom: 10px;">‚úÖ Restaurer</button>
                <button class="btn btn-secondary" onclick="closeRestoreModal()">‚ùå Annuler</button>
            </div>
        </div>
    </div>

    <!-- Player Details Modal -->
    <div class="player-details-modal" id="playerDetailsModal">
        <div class="modal-overlay" onclick="closePlayerDetails()">
            <div class="player-details-card" onclick="event.stopPropagation()">
                <div class="player-details-header">
                    <div class="player-details-avatar" id="detailsAvatar">E</div>
                    <div class="profile-name" id="detailsName">Joueur</div>
                    <div class="profile-level" id="detailsLevel">ü•â D√©butant</div>
                </div>
                <div class="stats">
                    <div class="stat-row">
                        <span class="stat-label">Points totaux</span>
                        <span class="stat-value" id="detailsPoints">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Taux de r√©ussite</span>
                        <span class="stat-value" id="detailsAccuracy">0%</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Badges gagn√©s</span>
                        <span class="stat-value" id="detailsBadges">0 üèÖ</span>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="closePlayerDetails()" style="margin-top: 20px;">Fermer</button>
            </div>
        </div>
    </div>
</body>
</html>
